<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ãƒŸãƒ¼ã‚°ãƒªå·¦å³å°è©±ç´€éŒ„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --card-bg: #ffffff;
      --accent-soft: #ffe5f0;
      --accent-deep: #f06292;
      --text-main: #333333;
      --text-sub: #666666;
      --border: #dddff0;
      --danger: #e57373;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        "Noto Sans TC", "Noto Sans JP", sans-serif;
      background: #f3f4f6;
      color: var(--text-main);
    }

    .page {
      max-width: 1120px;
      margin: 0 auto;
      padding: 1.5rem 1rem 2.5rem;
    }

    @media (min-width: 768px) {
      .page {
        padding: 2.2rem 1.5rem 3.2rem;
      }
    }

    header.page-header {
      margin-bottom: 1.5rem;
    }

    header.page-header h1 {
      margin: 0 0 .4rem;
      font-size: 1.8rem;
      display: flex;
      align-items: center;
      gap: .5rem;
    }

    header.page-header h1 span.emoji {
      font-size: 1.7rem;
    }

    header.page-header p {
      margin: 0;
      color: var(--text-sub);
      font-size: .95rem;
      line-height: 1.6;
    }

    .layout {
      display: grid;
      grid-template-columns: minmax(0, .95fr) minmax(0, 1.35fr);
      gap: 1.25rem;
    }

    @media (max-width: 880px) {
      .layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: var(--card-bg);
      border-radius: 1rem;
      padding: 1rem 1rem 1.2rem;
      box-shadow: 0 8px 24px rgba(15,23,42,.08);
      border: 1px solid rgba(255,255,255,.8);
    }

    .card + .card { margin-top: .75rem; }

    .card-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: .5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .5rem;
    }

    .pill {
      font-size: .72rem;
      padding: .15rem .6rem;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent-deep);
      white-space: nowrap;
    }

    label.field {
      display: flex;
      flex-direction: column;
      gap: .2rem;
      font-size: .85rem;
      color: var(--text-sub);
      margin-bottom: .5rem;
    }

    label.field span.label-text {
      display: flex;
      align-items: center;
      gap: .25rem;
    }

    label.field span.required {
      color: #ef5350;
      font-size: .75rem;
    }

    input[type="text"],
    input[type="date"],
    textarea,
    select,
    input[type="number"] {
      border-radius: .6rem;
      border: 1px solid var(--border);
      padding: .35rem .5rem;
      font-size: .9rem;
      font-family: inherit;
      background: rgba(255,255,255,.9);
      min-height: 2rem;
      resize: vertical;
    }

    textarea {
      min-height: 70px;
      line-height: 1.5;
    }

    input:focus, textarea:focus, select:focus {
      outline: 2px solid var(--accent-soft);
      border-color: var(--accent-deep);
    }

    .field-hint {
      font-size: .75rem;
      color: #999;
    }

    .form-row {
      display: grid;
      gap: .5rem;
    }

    @media (min-width: 720px) {
      .form-row--2col {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    button {
      font-family: inherit;
      cursor: pointer;
      border-radius: 999px;
      border: none;
      padding: .4rem 1rem;
      font-size: .85rem;
      display: inline-flex;
      align-items: center;
      gap: .3rem;
      white-space: nowrap;
    }

    .btn-primary {
      background: #111827;
      color: white;
      font-weight: 600;
    }

    .btn-secondary {
      background: #f3f4f6;
      color: var(--text-sub);
      border: 1px solid #d1d5db;
    }

    .btn-danger {
      background: rgba(229, 115, 115, .08);
      color: var(--danger);
      border: 1px solid rgba(229,115,115,.5);
    }

    .btn-small {
      padding: .25rem .7rem;
      font-size: .8rem;
    }

    button:disabled {
      opacity: .6;
      cursor: default;
    }

    .small-text {
      font-size: .75rem;
      color: #999;
      margin-top: .4rem;
    }

    /* å·¦å´ï¼šå·¥å…·åˆ— */
    .left-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: .4rem;
      gap: .4rem;
      flex-wrap: wrap;
    }

    /* è¨­å®šå€ï¼šé ­åƒ & æš±ç¨± */
    .avatar-row {
      display: flex;
      gap: .75rem;
      flex-wrap: wrap;
    }

    .avatar-block {
      flex: 1 1 180px;
      min-width: 0;
      border-radius: .75rem;
      padding: .55rem .6rem .65rem;
      background: #f9fafb;
      border: 1px dashed #e5e7eb;
    }

    .avatar-block-title {
      display: flex;
      align-items: center;
      gap: .35rem;
      font-size: .85rem;
      font-weight: 600;
      margin-bottom: .4rem;
    }

    .avatar-block-title span.badge-side {
      font-size: .72rem;
      padding: .05rem .45rem;
      border-radius: 999px;
      background: white;
      border: 1px solid #e5e7eb;
      color: #6b7280;
    }

    .avatar-flex {
      display: flex;
      align-items: center;
      gap: .5rem;
    }

    .avatar-preview {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.4rem;
      overflow: hidden;
    }

    .avatar-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .avatar-controls {
      flex: 1 1 auto;
      min-width: 0;
    }

    .avatar-controls input[type="file"] {
      font-size: .7rem;
      margin-top: .2rem;
    }

    .bg-preview {
      margin-top: .4rem;
      font-size: .78rem;
      color: #777;
    }

    /* å ´æ¬¡åˆ—è¡¨ */
    #session-list {
      display: flex;
      flex-direction: column;
      gap: .35rem;
      max-height: 320px;
      overflow-y: auto;
      padding-right: .2rem;
    }

    .session-item {
      width: 100%;
      text-align: left;
      border-radius: .7rem;
      border: 1px solid transparent;
      background: #f9fafb;
      padding: .35rem .55rem;
      display: flex;
      flex-direction: column;
      gap: .1rem;
      transition: background .15s, border-color .15s, transform .08s;
    }

    .session-item:hover {
      background: #edf2ff;
      transform: translateY(-1px);
    }

    .session-item.is-active {
      border-color: #111827;
      background: #e5e7eb;
    }

    .session-mainline {
      font-size: .9rem;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      gap: .4rem;
    }

    .session-secondline {
      font-size: .78rem;
      color: var(--text-sub);
      display: flex;
      justify-content: space-between;
      gap: .4rem;
    }

    .empty-hint {
      font-size: .8rem;
      color: #999;
      text-align: center;
      padding: .6rem .3rem;
    }

    /* å³å´ header */
    .session-header-row {
      display: flex;
      flex-wrap: wrap;
      gap: .5rem;
      align-items: center;
      justify-content: space-between;
      margin-bottom: .5rem;
    }

    .session-header-main {
      display: flex;
      flex-direction: column;
      gap: .1rem;
    }

    .session-title-line {
      font-size: 1.05rem;
      font-weight: 600;
    }

    .session-sub-line {
      font-size: .82rem;
      color: var(--text-sub);
    }

    .session-header-actions {
      display: flex;
      flex-wrap: wrap;
      gap: .35rem;
    }

    .step-label {
      font-size: .8rem;
      color: #6b7280;
      padding: .15rem .6rem;
      border-radius: 999px;
      background: #f3f4f6;
      display: inline-flex;
      align-items: center;
      gap: .25rem;
      margin-bottom: .35rem;
    }

    .meta-grid {
      display: grid;
      gap: .4rem;
      margin-bottom: .6rem;
    }

    @media (min-width: 720px) {
      .meta-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    .meta-chip {
      font-size: .78rem;
      color: var(--text-sub);
      background: #f9fafb;
      border-radius: 999px;
      padding: .2rem .6rem;
      display: inline-flex;
      align-items: center;
      gap: .25rem;
      border: 1px solid #e5e7eb;
    }

    /* æˆå“¡é ­åƒå€ï¼šä»¿æˆªåœ– */
    .member-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: .6rem;
      gap: .5rem;
    }

    .member-header-main {
      flex: 1 1 auto;
      text-align: center;
    }

    .member-header-avatar {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      background: #e5e7eb;
      border: 3px solid #f3f4f6;
      margin: 0 auto .4rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      overflow: hidden;
    }

    .member-header-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .member-header-name {
      font-size: 1.05rem;
      font-weight: 600;
    }

    .member-header-date {
      font-size: .86rem;
      color: #6b7280;
      margin-top: .1rem;
    }

    .member-header-stats {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: .35rem;
      margin-right: .2rem;
      min-width: 52px;
    }

    .member-stat {
      display: flex;
      align-items: center;
      gap: .2rem;
      font-size: .9rem;
      color: #4b5563;
    }

    .member-stat-icon {
      font-size: 1.1rem;
      width: 1.4rem;
      text-align: center;
    }

    .member-stat-value {
      min-width: 1.4rem;
      text-align: left;
    }

    @media (max-width: 600px) {
      .member-header {
        flex-direction: column;
        align-items: center;
      }
      .member-header-stats {
        flex-direction: row;
        justify-content: center;
        margin-right: 0;
      }
    }

    /* èŠå¤©è¦–çª—ï¼šæ¥è¿‘ LINE */
    .chat-container {
      border-radius: 1rem;
      background: #ffffff;
      border: 1px solid #e5e7eb;
      padding: .5rem;
      display: flex;
      flex-direction: column;
      gap: .35rem;
      max-height: 420px;
      min-height: 250px;
      position: relative;
      overflow: hidden;
      background-size: cover;
      background-position: center;
    }

    .chat-container::before {
      content: "";
      position: absolute;
      inset: 0;
      background: rgba(255,255,255,0.9); /* èƒŒæ™¯åœ–æ·¡æ·¡ä¸€å±¤ */
      pointer-events: none;
    }

    .chat-window,
    .chat-footer {
      position: relative;
    }

    .chat-window {
      flex: 1 1 auto;
      overflow-y: auto;
      padding: .2rem;
      display: flex;
      flex-direction: column;
      gap: .2rem;
    }

    .msg-row {
      display: flex;
      gap: .25rem;
      align-items: flex-end;
    }

    .msg-row--member {
      justify-content: flex-start;
    }

    .msg-row--me {
      justify-content: flex-end;
    }

    .msg-row--narration {
      justify-content: center;
    }

    .msg-avatar {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: .9rem;
      flex-shrink: 0;
      overflow: hidden;
    }

    .msg-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .msg-bubble-wrap {
      max-width: 77%;
      display: flex;
      flex-direction: column;
    }

    @media (min-width: 720px) {
      .msg-bubble-wrap {
        max-width: 70%;
      }
    }

    .msg-bubble {
      border-radius: 999px;
      padding: 2px 10px;      /* ç·Šè²¼æ–‡å­— */
      font-size: .9rem;
      line-height: 1.25;
      white-space: pre-wrap;
      word-break: break-word;
      display: inline-block;
    }

    .msg-bubble--member {
      background: #f3f4f6;
      border: 1px solid #e5e7eb;
    }

    .msg-bubble--me {
      background: #e5f2ff;
      border: 1px solid #bfdbfe;
    }

    /* ç½®ä¸­æè¿°æ–‡å­—ï¼ˆæ²’æœ‰å°è©±æ¡†ï¼‰ */
.msg-narration-text {
  font-size: .85rem;
  color: #6b7280;
  text-align: center;
  line-height: 1.4;
  padding: .15rem .4rem;
}

    .msg-line-jp {
      margin-bottom: 1px;   /* å¹¾ä¹æ²’æœ‰ç¸«éš™ */
      font-size: .9rem;
    }

    .msg-line-zh {
      font-size: .86rem;
      opacity: .95;
    }

    .chat-footer {
      border-top: 1px solid #e5e7eb;
      padding-top: .35rem;
      display: flex;
      justify-content: flex-end;
      gap: .4rem;
      flex-wrap: wrap;
    }

    .note-area {
      margin-top: .65rem;
    }

    /* å½ˆè·³è¼¸å…¥é¢æ¿ */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }

    .modal-backdrop.is-open {
      display: flex;
    }

    .modal-dialog {
      width: 100%;
      max-width: 520px;
      max-height: 90vh;
      overflow-y: auto;
      background: #ffffff;
      border-radius: 1rem;
      box-shadow: 0 18px 45px rgba(15,23,42,.35);
      padding: .9rem .95rem 1rem;
      border: 1px solid #e5e7eb;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: .5rem;
      margin-bottom: .4rem;
    }

    .modal-title {
      font-size: 1rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: .4rem;
    }

    .modal-close-btn {
      border-radius: 999px;
      border: none;
      background: #f3f4f6;
      padding: .15rem .5rem;
      font-size: .85rem;
      cursor: pointer;
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: .4rem;
      margin-top: .4rem;
      flex-wrap: wrap;
    }
/* ===== æ»¿ç‰ˆé¡¯ç¤ºæ¨¡å¼ ===== */
body.full-view .layout {
  grid-template-columns: minmax(0, 1fr);
}

body.full-view .layout > :first-child {
  display: none;             /* å·¦å´åˆ—è¡¨ï¼†è¨­å®šéš±è— */
}

body.full-view .page {
  max-width: 800px;          /* ä¸­å¤®è¼ƒçª„ã€åƒæ‰‹æ©Ÿæˆªåœ– */
}

body.full-view .card {
  box-shadow: none;
  border-radius: 0;
  border-left: none;
  border-right: none;
}

/* èŠå¤©å€é«˜åº¦æ”¾å¯¬ï¼Œå¹¾ä¹æ•´é  */
body.full-view #chat-container {
  max-height: none;
  min-height: 65vh;
}

/* é é¦–ç°¡åŒ–ä¸€ä¸‹é–“è·ï¼ˆå¯è¦–æƒ…æ³èª¿ï¼‰ */
body.full-view header.page-header {
  margin-bottom: 0.6rem;
}
  </style>
</head>
<body>
  <div class="page">
    <header class="page-header">
      <h1>
        <span class="emoji">ğŸ’¬</span>
        ãƒŸãƒ¼ã‚°ãƒªå·¦å³å°è©±ç´€éŒ„
      </h1>
      <p>
        å…ˆå¡«å¯«æ¯ä¸€å ´çš„åŸºæœ¬è³‡è¨Šï¼ˆæ—¥æœŸã€æˆå“¡ã€éƒ¨æ•¸ã€æšæ•¸ã€ç§’æ•¸ï¼‰ï¼Œå†ç”¨èŠå¤©è¦–çª—è¨˜éŒ„å°è©±ã€‚  
        ä¸€å‰‡è¨Šæ¯å¯ä»¥æ”¾ã€Œæ—¥æ–‡åŸæ–‡ï¼‹ä¸­æ–‡ç¿»è­¯ã€ï¼Œä¹Ÿå¯ä»¥åŠ å…¥ç½®ä¸­çš„ã€Œæè¿°ï¼æƒ…å¢ƒã€ã€‚  
        æ‰€æœ‰è³‡æ–™éƒ½åªå­˜é€™å°é›»è…¦çš„ç€è¦½å™¨ï¼ˆlocalStorageï¼‰ï¼Œä¸æœƒä¸Šå‚³ã€‚
      </p>
    </header>

    <div class="layout">
      <!-- å·¦å´ï¼šè¨­å®š & å ´æ¬¡åˆ—è¡¨ -->
      <div>
        <div class="left-toolbar">
          <div style="font-size:.86rem; color:#777;">
            å ´æ¬¡ç®¡ç†
          </div>
          <button class="btn-secondary btn-small" id="toggle-settings-btn">
            âš™ é¡¯ç¤ºï¼èƒŒæ™¯è¨­å®š
          </button>
        </div>

        <!-- é¡¯ç¤ºè¨­å®šï¼ˆé è¨­æ”¶èµ·ï¼‰ -->
        <section class="card" id="display-settings-card" style="display:none;">
          <div class="card-title">
            é¡¯ç¤ºè¨­å®š
            <span class="pill">å¥—ç”¨åˆ°æ‰€æœ‰å ´æ¬¡</span>
          </div>

          <div class="avatar-row">
            <div class="avatar-block">
              <div class="avatar-block-title">
                ğŸ«¶ æˆ‘é€™ä¸€å´
                <span class="badge-side">å³å´æ°£æ³¡</span>
              </div>
              <div class="avatar-flex">
                <div class="avatar-preview" id="me-avatar-preview">
                  <span>ğŸ™‚</span>
                </div>
                <div class="avatar-controls">
                  <label class="field">
                    <span class="label-text">æš±ç¨±ï¼ˆå¦‚ï¼šCoCoï¼‰</span>
                    <input type="text" id="me-name" placeholder="é¡¯ç¤ºåœ¨å³å´æ°£æ³¡" />
                  </label>
                  <input type="file" id="me-avatar-file" accept="image/*" />
                </div>
              </div>
            </div>

            <div class="avatar-block">
              <div class="avatar-block-title">
                âœ¨ æˆå“¡é€™ä¸€å´
                <span class="badge-side">å·¦å´æ°£æ³¡ & é é¢ä¸Šæ–¹</span>
              </div>
              <div class="avatar-flex">
                <div class="avatar-preview" id="member-avatar-preview">
                  <span>â­</span>
                </div>
                <div class="avatar-controls">
                  <label class="field">
                    <span class="label-text">æš±ç¨±ï¼ˆå¦‚ï¼šçŸ³æ£®ç’ƒèŠ±ï¼‰</span>
                    <input type="text" id="member-name" placeholder="é¡¯ç¤ºåœ¨ç•«é¢ä¸Šæ–¹" />
                  </label>
                  <input type="file" id="member-avatar-file" accept="image/*" />
                </div>
              </div>
            </div>
          </div>

          <label class="field" style="margin-top:.4rem;">
            <span class="label-text">èŠå¤©èƒŒæ™¯åœ–ç‰‡ï¼ˆå¯ç•™ç™½ï¼‰</span>
            <input type="file" id="bg-image-file" accept="image/*" />
            <span class="field-hint">å¥—ç”¨åœ¨å³å´èŠå¤©å€ï¼Œå»ºè­°ä½¿ç”¨é¡è‰²è¼ƒæŸ”å’Œçš„åœ–ç‰‡ã€‚</span>
          </label>
          <button class="btn-secondary btn-small" id="clear-bg-btn">ğŸ§¹ æ¸…é™¤èƒŒæ™¯åœ–ç‰‡</button>
          <div class="bg-preview" id="bg-preview-text"></div>
        </section>

        <!-- å ´æ¬¡åˆ—è¡¨ -->
        <section class="card">
          <div class="card-title">
            å ´æ¬¡åˆ—è¡¨
            <span class="pill" id="session-count">0 å ´</span>
          </div>
          <div id="session-list">
            <div class="empty-hint">
              é‚„æ²’æœ‰ä»»ä½•ç´€éŒ„ã€‚å³é‚Šå…ˆæ–°å»ºä¸€å ´ï¼Œå†å¡«å°è©±å…§å®¹ã€‚
            </div>
          </div>
          <div class="small-text">
            å¯ä»¥ä¸€å ´å¯«ä¸€å¼µåˆ¸ï¼Œæˆ–æŠŠåŒä¸€éƒ¨åˆä½µæˆä¸€å ´ï¼Œä¾è‡ªå·±çš„æ•´ç†ç¿’æ…£ä¾†ç”¨ã€‚
          </div>
        </section>
      </div>

      <!-- å³å´ï¼šå ´æ¬¡ç·¨è¼¯ + èŠå¤©è¦–çª— -->
      <div>
        <section class="card">
          <div class="session-header-row">
            <div class="session-header-main">
              <div class="session-title-line" id="session-title-line">
                å°šæœªé¸æ“‡å ´æ¬¡
              </div>
              <div class="session-sub-line" id="session-sub-line">
                è«‹å…ˆæ–°å»ºä¸€å ´ï¼Œæˆ–åœ¨å·¦å´é»é¸æ—¢æœ‰ç´€éŒ„ã€‚
              </div>
            </div>
            <div class="session-header-actions">
<button class="btn-secondary btn-small" id="fullscreen-btn" disabled>
    â›¶ æ»¿ç‰ˆé¡¯ç¤º
  </button>
              <button class="btn-secondary btn-small" id="new-session-btn">
                ğŸ†• æ–°å»ºå ´æ¬¡
              </button>
              <button class="btn-danger btn-small" id="delete-session-btn" disabled>
                ğŸ—‘ åˆªé™¤æ­¤å ´
              </button>
            </div>
          </div>

          <!-- æ­¥é©Ÿä¸€ï¼šåŸºæœ¬è³‡è¨Š -->
          <div id="step-basic">
            <div class="step-label">
              â‘  å¡«å¯«å ´æ¬¡åŸºæœ¬è³‡è¨Š
            </div>

            <div class="form-row form-row--2col">
              <label class="field">
                <span class="label-text">
                  æ—¥æœŸ
                  <span class="required">å¿…å¡«</span>
                </span>
                <input type="date" id="session-date" />
              </label>
              <label class="field">
                <span class="label-text">
                  æˆå“¡åç¨±
                  <span class="required">å¿…å¡«</span>
                </span>
                <input type="text" id="session-member" placeholder="ä¾‹å¦‚ï¼šçŸ³æ£®ç’ƒèŠ±" />
              </label>
            </div>

            <div class="form-row form-row--2col">
              <label class="field">
                <span class="label-text">æ´»å‹•åç¨±ï¼å–®</span>
                <input type="text" id="session-event" placeholder="ä¾‹å¦‚ï¼š14th ãƒŸãƒ¼ã‚°ãƒªç¬¬3æ¬¡" />
              </label>
              <label class="field">
                <span class="label-text">éƒ¨æ•¸</span>
                <select id="session-slot">
                  <option value="">ï¼ˆæœªé¸æ“‡ï¼‰</option>
                  <option value="ç¬¬1éƒ¨">ç¬¬1éƒ¨</option>
                  <option value="ç¬¬2éƒ¨">ç¬¬2éƒ¨</option>
                  <option value="ç¬¬3éƒ¨">ç¬¬3éƒ¨</option>
                  <option value="ç¬¬4éƒ¨">ç¬¬4éƒ¨</option>
                  <option value="ç¬¬5éƒ¨">ç¬¬5éƒ¨</option>
                  <option value="ç¬¬6éƒ¨">ç¬¬6éƒ¨</option>
                </select>
              </label>
            </div>

            <div class="form-row form-row--2col">
              <label class="field">
                <span class="label-text">æšæ•¸</span>
                <input type="number" id="session-count-input" placeholder="3" min="1" step="1" />
              </label>
              <label class="field">
                <span class="label-text">ç§’æ•¸</span>
                <input type="number" id="session-seconds" placeholder="30" min="1" step="1" />
              </label>
            </div>

            <label class="field">
              <span class="label-text">æ¨™ç±¤</span>
              <input type="text" id="session-tags" placeholder="ç”¨ç©ºæ ¼åˆ†é–‹ï¼Œä¾‹å¦‚ï¼šç”Ÿæ—¥ åˆé¸æŠœ BACKS" />
              <span class="field-hint">æœƒç”¨ä¾†é¡¯ç¤ºåœ¨å·¦å´åˆ—è¡¨çš„å°æ¨™è¨˜ï¼Œç´”ç²¹çµ¦è‡ªå·±çœ‹ã€‚</span>
            </label>

            <div class="meta-grid" id="meta-preview"></div>

            <div class="note-area">
              <label class="field">
                <span class="label-text">å‚™è¨»ï¼å¿ƒæƒ…</span>
                <textarea id="session-note" placeholder="ä»Šå¤©çš„åæ‡‰ã€è‡ªå·±èªªè©±é †ä¸é †ã€ä¸‹æ¬¡æƒ³è·Ÿå¥¹èªªä»€éº¼â€¦éƒ½å¯ä»¥å¯«åœ¨é€™è£¡ã€‚"></textarea>
              </label>
            </div>

            <div style="margin-top:.4rem; display:flex; justify-content:flex-end; gap:.4rem; flex-wrap:wrap;">
              <button class="btn-primary" id="go-chat-btn">
                â¡ ä¸‹ä¸€æ­¥ï¼šè¼¸å…¥å°è©±
              </button>
            </div>
          </div>

          <!-- æ­¥é©ŸäºŒï¼šå°è©±å…§å®¹ -->
          <div id="step-chat" style="display:none;">
            <div class="step-label">
              â‘¡ è¼¸å…¥å°è©±å…§å®¹
            </div>

            <!-- æˆå“¡é ­åƒï¼‹ä¸Šæ–¹è³‡è¨Š -->
            <div class="member-header">
              <div class="member-header-main">
                <div class="member-header-avatar" id="header-member-avatar">
                  <span>â­</span>
                </div>
                <div class="member-header-name" id="header-member-name">æˆå“¡åç¨±æœªå¡«</div>
                <div class="member-header-date" id="header-member-date">--/--/--</div>
              </div>
              <div class="member-header-stats">
                <div class="member-stat">
                  <span class="member-stat-icon">ğŸ§¾</span>
                  <span class="member-stat-value" id="header-count">-</span>
                </div>
                <div class="member-stat">
                  <span class="member-stat-icon">â±</span>
                  <span class="member-stat-value" id="header-seconds">-</span>
                </div>
              </div>
            </div>

            <div class="chat-container" id="chat-container">
              <div class="chat-window" id="chat-window">
                <div class="empty-hint">
                  é‚„æ²’æœ‰ä»»ä½•è¨Šæ¯ã€‚æŒ‰ä¸‹æ–¹ã€Œæ–°å¢è¨Šæ¯ã€æ‰“é–‹è¼¸å…¥é¢æ¿ï¼Œ  
                  è¼¸å…¥æ—¥æ–‡åŸæ–‡ï¼ä¸­æ–‡ç¿»è­¯å°±æœƒå‡ºç¾åœ¨é€™è£¡ã€‚  
                  å¯ä»¥å…ˆåªè¨˜æ—¥æ–‡ï¼Œä¸­æ–‡ä¹‹å¾Œæ…¢æ…¢è£œã€‚
                </div>
              </div>

              <div class="chat-footer">
                <button class="btn-secondary btn-small" id="back-basic-btn">
                  â¬… è¿”å›åŸºæœ¬è³‡è¨Š
                </button>
                <button class="btn-secondary btn-small" id="clear-msg-btn">
                  â™» æ¸…ç©ºæœ¬å ´å°è©±
                </button>
                <button class="btn-primary btn-small" id="open-msg-modal-btn">
                  â• æ–°å¢è¨Šæ¯
                </button>
              </div>
            </div>

            <div style="margin-top:.6rem; display:flex; justify-content:flex-end; gap:.4rem; flex-wrap:wrap;">
              <button class="btn-primary btn-small" id="save-session-btn">
                âœ” å®Œæˆï¼å„²å­˜
              </button>
            </div>

            <div class="small-text">
              æœƒå„²å­˜åˆ°ç€è¦½å™¨å·¦å´åˆ—è¡¨ï¼›å°è©±å·²ç¶“åœ¨åŒä¸€é å±•é–‹ï¼Œå¯ä»¥ç›´æ¥æˆªåœ–æˆ–è‡ªå·±æ’ç‰ˆã€‚
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- å½ˆè·³è¼¸å…¥é¢æ¿ -->
  <div class="modal-backdrop" id="msg-modal">
    <div class="modal-dialog">
      <div class="modal-header">
        <div class="modal-title">
          âœï¸ æ–°å¢è¨Šæ¯
        </div>
        <button type="button" class="modal-close-btn" id="close-msg-modal-btn">é—œé–‰</button>
      </div>

      <label class="field">
        <span class="label-text">èª°èªªçš„ï¼Ÿ</span>
        <select id="msg-role">
          <option value="member">æˆå“¡ï¼ˆå·¦å´ï¼‰</option>
          <option value="me">æˆ‘ï¼ˆå³å´ï¼‰</option>
          <option value="narration">æè¿°ï¼æƒ…å¢ƒï¼ˆç½®ä¸­ï¼‰</option>
        </select>
      </label>

      <label class="field">
        <span class="label-text">æ—¥æ–‡åŸæ–‡</span>
        <textarea id="msg-text-jp" placeholder="ä¾‹ï¼šã€ä»Šæ—¥ã‚‚æ¥ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã€œï¼ã€"></textarea>
      </label>

      <label class="field">
        <span class="label-text">ä¸­æ–‡ç¿»è­¯ï¼ˆå¯ç•™ç™½ï¼‰</span>
        <textarea id="msg-text-zh" placeholder="ä¾‹ï¼šã€ä»Šå¤©ä¹Ÿä¾†è¦‹æˆ‘ï¼ŒçœŸçš„è¬è¬ä½ ã€œã€"></textarea>
        <span class="field-hint">å¯ä»¥å…ˆåªå¯«æ—¥æ–‡ï¼Œä¹‹å¾Œæ…¢æ…¢è£œç¿»è­¯ã€‚æŒ‰ Ctrl+Enter / âŒ˜+Enter ä¹Ÿå¯ä»¥å¿«é€ŸåŠ å…¥è¨Šæ¯ã€‚</span>
      </label>

      <div class="modal-footer">
        <button type="button" class="btn-secondary btn-small" id="cancel-msg-btn">å–æ¶ˆ</button>
        <button type="button" class="btn-primary btn-small" id="add-msg-btn">â• åŠ å…¥è¨Šæ¯</button>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const RECORDS_KEY = "meetlog_chat_records_v1";
      const SETTINGS_KEY = "meetlog_chat_settings_v1";

      let records = [];
      let settings = {
        meName: "",
        memberName: "",
        meAvatar: "",
        memberAvatar: "",
        bgImage: ""
      };

      let editingId = null;
      let currentMessages = [];

      // ---- DOM ----
      const toggleSettingsBtn = document.getElementById("toggle-settings-btn");
      const displaySettingsCard = document.getElementById("display-settings-card");

      const meNameInput = document.getElementById("me-name");
      const memberNameInput = document.getElementById("member-name");
      const meAvatarFile = document.getElementById("me-avatar-file");
      const memberAvatarFile = document.getElementById("member-avatar-file");
      const meAvatarPreview = document.getElementById("me-avatar-preview");
      const memberAvatarPreview = document.getElementById("member-avatar-preview");

      const bgImageFile = document.getElementById("bg-image-file");
      const clearBgBtn = document.getElementById("clear-bg-btn");
      const bgPreviewText = document.getElementById("bg-preview-text");

      const sessionListEl = document.getElementById("session-list");
      const sessionCountEl = document.getElementById("session-count");

      const sessionTitleLine = document.getElementById("session-title-line");
      const sessionSubLine = document.getElementById("session-sub-line");

      const stepBasic = document.getElementById("step-basic");
      const stepChat = document.getElementById("step-chat");

      const sessionDate = document.getElementById("session-date");
      const sessionMember = document.getElementById("session-member");
      const sessionEvent = document.getElementById("session-event");
      const sessionSlot = document.getElementById("session-slot");
      const sessionCountInput = document.getElementById("session-count-input");
      const sessionSeconds = document.getElementById("session-seconds");
      const sessionTags = document.getElementById("session-tags");
      const sessionNote = document.getElementById("session-note");
      const metaPreview = document.getElementById("meta-preview");

      const goChatBtn = document.getElementById("go-chat-btn");
      const backBasicBtn = document.getElementById("back-basic-btn");

      const chatContainer = document.getElementById("chat-container");
      const chatWindow = document.getElementById("chat-window");
      const clearMsgBtn = document.getElementById("clear-msg-btn");
      const openMsgModalBtn = document.getElementById("open-msg-modal-btn");

      const headerMemberAvatar = document.getElementById("header-member-avatar");
      const headerMemberName = document.getElementById("header-member-name");
      const headerMemberDate = document.getElementById("header-member-date");
      const headerCount = document.getElementById("header-count");
      const headerSeconds = document.getElementById("header-seconds");

      const msgModal = document.getElementById("msg-modal");
      const closeMsgModalBtn = document.getElementById("close-msg-modal-btn");
      const cancelMsgBtn = document.getElementById("cancel-msg-btn");
      const msgRole = document.getElementById("msg-role");
      const msgTextJp = document.getElementById("msg-text-jp");
      const msgTextZh = document.getElementById("msg-text-zh");
      const addMsgBtn = document.getElementById("add-msg-btn");

      const newSessionBtn = document.getElementById("new-session-btn");
const deleteSessionBtn = document.getElementById("delete-session-btn");
const saveSessionBtn = document.getElementById("save-session-btn");
const fullscreenBtn = document.getElementById("fullscreen-btn");

let isFullscreen = false;

      // ---- Utils ----
      function escapeHtml(str) {
        if (!str) return "";
        return String(str).replace(/[&<>"']/g, function (s) {
          return {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#39;"
          }[s];
        });
      }

      function formatCountStr(count) {
        if (!count && count !== 0) return "";
        let s = String(count).trim();
        s = s.replace(/æš$/, "");
        if (!s) return "";
        return s + "æš";
      }

      function formatSecondsStr(sec) {
        if (!sec && sec !== 0) return "";
        let s = String(sec).trim();
        s = s.replace(/ç§’$/, "");
        if (!s) return "";
        return s + "ç§’";
      }

      function loadSettings() {
        try {
          const raw = localStorage.getItem(SETTINGS_KEY);
          if (!raw) return;
          const parsed = JSON.parse(raw);
          if (parsed && typeof parsed === "object") {
            settings = Object.assign(settings, parsed);
          }
        } catch (e) {
          console.warn("è¨­å®šè®€å–å¤±æ•—", e);
        }
      }

      function saveSettings() {
        try {
          localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
        } catch (e) {
          console.warn("è¨­å®šå„²å­˜å¤±æ•—", e);
        }
      }

      function loadRecords() {
        try {
          const raw = localStorage.getItem(RECORDS_KEY);
          if (!raw) return [];
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) return parsed;
          return [];
        } catch (e) {
          console.warn("ç´€éŒ„è®€å–å¤±æ•—", e);
          return [];
        }
      }

      function saveRecords() {
        try {
          localStorage.setItem(RECORDS_KEY, JSON.stringify(records));
        } catch (e) {
          alert("ç„¡æ³•å„²å­˜ç´€éŒ„ï¼ˆlocalStorage å¯èƒ½å·²æ»¿ï¼‰");
          console.error(e);
        }
      }

      function formatDateForDisplay(dateStr) {
        if (!dateStr) return "æœªå¡«æ—¥æœŸ";
        return dateStr;
      }

      // ---- Avatar / Name / BG ----
      function updateAvatarPreviews() {
        if (settings.meAvatar) {
          meAvatarPreview.innerHTML = '<img src="' + settings.meAvatar + '" alt="me avatar" />';
        } else {
          meAvatarPreview.innerHTML = "<span>ğŸ™‚</span>";
        }

        if (settings.memberAvatar) {
          memberAvatarPreview.innerHTML = '<img src="' + settings.memberAvatar + '" alt="member avatar" />';
          headerMemberAvatar.innerHTML = '<img src="' + settings.memberAvatar + '" alt="member avatar" />';
        } else {
          memberAvatarPreview.innerHTML = "<span>â­</span>";
          headerMemberAvatar.innerHTML = "<span>â­</span>";
        }

        meNameInput.value = settings.meName || "";
        memberNameInput.value = settings.memberName || "";
        updateMemberHeader();
      }

      function updateChatBackground() {
        if (!chatContainer) return;
        if (settings.bgImage) {
          chatContainer.style.backgroundImage = 'url("' + settings.bgImage + '")';
          bgPreviewText.textContent = "å·²å¥—ç”¨èƒŒæ™¯åœ–ç‰‡ã€‚";
        } else {
          chatContainer.style.backgroundImage = "none";
          bgPreviewText.textContent = "ç›®å‰æ²’æœ‰èƒŒæ™¯åœ–ç‰‡ã€‚";
        }
      }

      function handleAvatarFile(fileInput, key) {
        const file = fileInput.files && fileInput.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
          settings[key] = e.target.result || "";
          saveSettings();
          updateAvatarPreviews();
          renderChat();
        };
        reader.readAsDataURL(file);
      }

      function handleBgFile() {
        const file = bgImageFile.files && bgImageFile.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
          settings.bgImage = e.target.result || "";
          saveSettings();
          updateChatBackground();
        };
        reader.readAsDataURL(file);
      }
      function enterFullscreen() {
        if (isFullscreen) return;
        document.body.classList.add("full-view");
        isFullscreen = true;
        fullscreenBtn.textContent = "âŒ é—œé–‰æ»¿ç‰ˆ";
      }

      function exitFullscreen() {
        if (!isFullscreen) return;
        document.body.classList.remove("full-view");
        isFullscreen = false;
        fullscreenBtn.textContent = "â›¶ æ»¿ç‰ˆé¡¯ç¤º";
      }

      // ---- Step control ----
      function showBasicStep() {
        stepBasic.style.display = "block";
        stepChat.style.display = "none";
      }

      function showChatStep() {
        stepBasic.style.display = "none";
        stepChat.style.display = "block";
      }

      // ---- Sessions list ----
      function renderSessionList() {
        if (!records.length) {
          sessionListEl.innerHTML =
            '<div class="empty-hint">é‚„æ²’æœ‰ä»»ä½•å ´æ¬¡ï¼Œå³é‚Šã€Œæ–°å»ºå ´æ¬¡ã€å¾Œå„²å­˜å°±æœƒå‡ºç¾åœ¨é€™è£¡ã€‚</div>';
          sessionCountEl.textContent = "0 å ´";
          return;
        }

        const sorted = records.slice().sort((a, b) => {
          const da = a.date ? new Date(a.date).getTime() : 0;
          const db = b.date ? new Date(b.date).getTime() : 0;
          if (da !== db) return db - da;
          return (b.createdAt || 0) - (a.createdAt || 0);
        });

        const html = sorted
          .map(r => {
            const activeClass = r.id === editingId ? " is-active" : "";
            const dateText = formatDateForDisplay(r.date);
            const memberText = r.member || "æœªå¡«æˆå“¡";
            const eventText = r.eventName || "";
            const countText = formatCountStr(r.count);
            const secText = formatSecondsStr(r.seconds);
            const tags = (r.tags || "").split(/\s+/).filter(Boolean);

            const secondLeft = eventText || "";
            const rightPieces = [];
            if (r.slot) rightPieces.push(r.slot);
            if (countText) rightPieces.push(countText);
            if (secText) rightPieces.push(secText);
            const secondRight =
              rightPieces.join(" Â· ") || (tags.length ? "#" + tags[0] : "");

            return `
              <button class="session-item${activeClass}" data-id="${r.id}">
                <div class="session-mainline">
                  <span>${escapeHtml(dateText)} ï½œ ${escapeHtml(memberText)}</span>
                  <span style="font-size:.78rem; color:#6b7280;">${r.messages?.length || 0} å‰‡</span>
                </div>
                <div class="session-secondline">
                  <span>${escapeHtml(secondLeft)}</span>
                  <span>${escapeHtml(secondRight)}</span>
                </div>
              </button>
            `;
          })
          .join("");

        sessionListEl.innerHTML = html;
        sessionCountEl.textContent = records.length + " å ´";
      }

      function findRecordById(id) {
        return records.find(r => r.id === id) || null;
      }

      function setActiveSession(id) {
        editingId = id;
        const record = findRecordById(id);
        if (!record) return;

        sessionDate.value = record.date || "";
        sessionMember.value = record.member || "";
        sessionEvent.value = record.eventName || "";
        sessionSlot.value = record.slot || "";
        sessionCountInput.value = record.count || "";
        sessionSeconds.value = record.seconds || "";
        sessionTags.value = record.tags || "";
        sessionNote.value = record.note || "";

        // èˆŠè³‡æ–™å…¼å®¹ï¼šå¦‚æœ messages è£¡åªæœ‰ textï¼Œå°±ç•¶ä½œ jp
        currentMessages = Array.isArray(record.messages)
          ? record.messages.map(m => {
              if (m.jp !== undefined || m.zh !== undefined) return m;
              return {
                id: m.id || ("m_" + (m.createdAt || Date.now())),
                role: m.role || "member",
                jp: m.text || "",
                zh: "",
                createdAt: m.createdAt || Date.now()
              };
            })
          : [];

        const dateText = formatDateForDisplay(record.date);
        sessionTitleLine.textContent =
          dateText + " ï½œ " + (record.member || "æœªå¡«æˆå“¡");

        let subParts = [];
        if (record.eventName) subParts.push(record.eventName);
        if (record.slot) subParts.push(record.slot);
        sessionSubLine.textContent = subParts.join(" ï¼ ") || "é€™ä¸€å ´çš„è©³ç´°è³‡è¨Šé‚„æ²’å¯«ã€‚";

        deleteSessionBtn.disabled = false;
        fullscreenBtn.disabled = false;

        updateMetaPreview();
        updateMemberHeader();
        renderChat();
        renderSessionList();

        showChatStep();
      }

      function resetSessionForm() {
        editingId = null;
        sessionDate.value = "";
        sessionMember.value = "";
        sessionEvent.value = "";
        sessionSlot.value = "";
        sessionCountInput.value = "";
        sessionSeconds.value = "";
        sessionTags.value = "";
        sessionNote.value = "";
        currentMessages = [];

        sessionTitleLine.textContent = "å°šæœªé¸æ“‡å ´æ¬¡";
        sessionSubLine.textContent = "è«‹å…ˆæ–°å»ºä¸€å ´ï¼Œæˆ–åœ¨å·¦å´é»é¸æ—¢æœ‰ç´€éŒ„ã€‚";
        deleteSessionBtn.disabled = true;
        fullscreenBtn.disabled = true;
        exitFullscreen();   // å›åˆ°ä¸€èˆ¬æ¨¡å¼

        updateMetaPreview();
        updateMemberHeader();
        renderChat();
        renderSessionList();

        showBasicStep();
      }

      // ---- Meta preview & member header ----
      function updateMetaPreview() {
        const chips = [];
        const dateStr = sessionDate.value.trim();
        const slotStr = sessionSlot.value.trim();
        const countStr = sessionCountInput.value.trim();
        const secStr = sessionSeconds.value.trim();
        const tagStr = sessionTags.value.trim();

        if (dateStr) {
          chips.push('<div class="meta-chip">ğŸ“… ' + escapeHtml(dateStr) + "</div>");
        }
        if (slotStr) {
          chips.push('<div class="meta-chip">ğŸ•’ ' + escapeHtml(slotStr) + "</div>");
        }
        if (countStr) {
          chips.push('<div class="meta-chip">ğŸ« ' + escapeHtml(formatCountStr(countStr)) + "</div>");
        }
        if (secStr) {
          chips.push('<div class="meta-chip">â± ' + escapeHtml(formatSecondsStr(secStr)) + "</div>");
        }

        if (tagStr) {
          const firstTag = tagStr.split(/\s+/).filter(Boolean)[0];
          if (firstTag) {
            chips.push('<div class="meta-chip">ğŸ· ' + escapeHtml(firstTag) + "</div>");
          }
        }

        metaPreview.innerHTML = chips.join("");
        updateMemberHeader();
      }

      function updateMemberHeader() {
        const name =
          settings.memberName ||
          sessionMember.value.trim() ||
          "æˆå“¡åç¨±æœªå¡«";
        headerMemberName.textContent = name;

        const dateStr = sessionDate.value.trim();
        headerMemberDate.textContent = dateStr || "--/--/--";

        const countStr = sessionCountInput.value.trim();
        const secStr = sessionSeconds.value.trim();

        headerCount.textContent = countStr || "-";
        headerSeconds.textContent = secStr || "-";
      }

      // ---- Chat rendering ----
      function getAvatarForRole(role) {
        if (role === "me") {
          return settings.meAvatar || "";
        } else if (role === "member") {
          return settings.memberAvatar || "";
        }
        return "";
      }

      function renderChat() {
        if (!currentMessages.length) {
          chatWindow.innerHTML =
            '<div class="empty-hint">é‚„æ²’æœ‰ä»»ä½•è¨Šæ¯ã€‚æŒ‰ã€Œæ–°å¢è¨Šæ¯ã€æ‰“é–‹è¼¸å…¥é¢æ¿ï¼Œå…ˆè¨˜æ—¥æ–‡ï¼Œå†æ…¢æ…¢è£œä¸­æ–‡ã€‚</div>';
          return;
        }

        const html = currentMessages
          .map(msg => {
            const isMe = msg.role === "me";
            const isNarration = msg.role === "narration";

            const hasNew = (msg.jp !== undefined || msg.zh !== undefined);
            const jpText = hasNew ? (msg.jp || "") : (msg.text || "");
            const zhText = hasNew ? (msg.zh || "") : "";

            if (!jpText && !zhText) return "";

            const jpHtml = jpText
              ? `<div class="msg-line-jp">${escapeHtml(jpText)}</div>`
              : "";
            const zhHtml = zhText
              ? `<div class="msg-line-zh">${escapeHtml(zhText)}</div>`
              : "";

            if (isNarration) {
              return `
                <div class="msg-row msg-row--narration">
      <div class="msg-narration-text">
                    ${jpHtml}${zhHtml}
                  </div>
                </div>
              `;
            }

            const avatarSrc = getAvatarForRole(msg.role);
            const rowClass = isMe ? "msg-row msg-row--me" : "msg-row msg-row--member";

            const avatarHtml = avatarSrc
              ? `<div class="msg-avatar"><img src="${avatarSrc}" alt="avatar" /></div>`
              : `<div class="msg-avatar">${isMe ? "ğŸ™‚" : "â­"}</div>`;

            const bubbleClass = isMe
              ? "msg-bubble msg-bubble--me"
              : "msg-bubble msg-bubble--member";

            const bubbleHtml = `
              <div class="${bubbleClass}">
                ${jpHtml}${zhHtml}
              </div>
            `;

            if (isMe) {
              return `
                <div class="${rowClass}">
                  <div class="msg-bubble-wrap" style="align-items:flex-end;">
                    ${bubbleHtml}
                  </div>
                  ${avatarHtml}
                </div>
              `;
            } else {
              return `
                <div class="${rowClass}">
                  ${avatarHtml}
                  <div class="msg-bubble-wrap">
                    ${bubbleHtml}
                  </div>
                </div>
              `;
            }
          })
          .join("");

        chatWindow.innerHTML = html;
        chatWindow.scrollTop = chatWindow.scrollHeight;
      }

      // ---- Message actions ----
      function addMessage() {
        let role = msgRole.value;
        if (role !== "me" && role !== "member" && role !== "narration") {
          role = "member";
        }
        const jp = msgTextJp.value.trim();
        const zh = msgTextZh.value.trim();

        if (!jp && !zh) return;

        const now = Date.now();
        currentMessages.push({
          id: "m_" + now + "_" + Math.random().toString(16).slice(2),
          role,
          jp,
          zh,
          createdAt: now
        });
        msgTextJp.value = "";
        msgTextZh.value = "";
        closeMsgModal();
        renderChat();
      }

      function clearMessages() {
        if (!currentMessages.length) return;
        const ok = confirm("ç¢ºå®šè¦æ¸…ç©ºé€™ä¸€å ´çš„æ‰€æœ‰å°è©±å—ï¼Ÿ");
        if (!ok) return;
        currentMessages = [];
        renderChat();
      }

      // ---- Modal control ----
      function openMsgModal() {
        msgModal.classList.add("is-open");
        msgRole.value = "member";
        msgTextJp.value = "";
        msgTextZh.value = "";
        msgTextJp.focus();
      }

      function closeMsgModal() {
        msgModal.classList.remove("is-open");
      }

      // ---- Save/Delete session ----
      function saveSession() {
        const date = sessionDate.value.trim();
        const member = sessionMember.value.trim();
        const eventName = sessionEvent.value.trim();
        const slot = sessionSlot.value.trim();
        const countStr = sessionCountInput.value.trim();
        const seconds = sessionSeconds.value.trim();
        const tags = sessionTags.value.trim();
        const note = sessionNote.value.trim();

        if (!date || !member) {
          alert("è«‹è‡³å°‘å¡«å¯«ã€Œæ—¥æœŸã€å’Œã€Œæˆå“¡åç¨±ã€ã€‚");
          return false;
        }
        if (!currentMessages.length) {
          alert("è«‹è‡³å°‘åŠ å…¥ä¸€å‰‡å°è©±è¨Šæ¯ï¼Œæ‰èƒ½å„²å­˜é€™ä¸€å ´ã€‚");
          return false;
        }

        const now = Date.now();

        if (editingId) {
          const idx = records.findIndex(r => r.id === editingId);
          if (idx !== -1) {
            records[idx] = Object.assign({}, records[idx], {
              date,
              member,
              eventName,
              slot,
              count: countStr,
              seconds,
              tags,
              note,
              messages: currentMessages.slice(),
              updatedAt: now
            });
          }
        } else {
          const newId = "s_" + now + "_" + Math.random().toString(16).slice(2);
          const record = {
            id: newId,
            date,
            member,
            eventName,
            slot,
            count: countStr,
            seconds,
            tags,
            note,
            messages: currentMessages.slice(),
            createdAt: now,
            updatedAt: now
          };
          records.push(record);
          editingId = newId;
        }

        saveRecords();
        renderSessionList();
        setActiveSession(editingId);
        return true;
      }

      function deleteSession() {
        if (!editingId) return;
        const ok = confirm("ç¢ºå®šè¦åˆªé™¤é€™ä¸€å ´å—ï¼Ÿåˆªé™¤å¾Œç„¡æ³•å¾©åŸã€‚");
        if (!ok) return;
        records = records.filter(r => r.id !== editingId);
        saveRecords();
        resetSessionForm();
      }

      // ---- Event listeners ----
      fullscreenBtn.addEventListener("click", function () {
        if (!editingId) return;        // æ²’é¸å ´æ¬¡å°±ä¸å‹•
        if (isFullscreen) {
          exitFullscreen();
        } else {
          enterFullscreen();
        }
      });

      toggleSettingsBtn.addEventListener("click", function () {
        const visible = displaySettingsCard.style.display !== "none";
        displaySettingsCard.style.display = visible ? "none" : "block";
      });

      meNameInput.addEventListener("input", function () {
        settings.meName = meNameInput.value.trim();
        saveSettings();
        renderChat();
      });
      memberNameInput.addEventListener("input", function () {
        settings.memberName = memberNameInput.value.trim();
        saveSettings();
        updateMemberHeader();
        renderChat();
      });

      meAvatarFile.addEventListener("change", function () {
        handleAvatarFile(meAvatarFile, "meAvatar");
      });
      memberAvatarFile.addEventListener("change", function () {
        handleAvatarFile(memberAvatarFile, "memberAvatar");
      });

      bgImageFile.addEventListener("change", handleBgFile);
      clearBgBtn.addEventListener("click", function () {
        settings.bgImage = "";
        saveSettings();
        updateChatBackground();
      });

      sessionListEl.addEventListener("click", function (e) {
        const btn = e.target.closest(".session-item");
        if (!btn) return;
        const id = btn.getAttribute("data-id");
        if (!id) return;
        setActiveSession(id);
      });

      sessionDate.addEventListener("change", updateMetaPreview);
      sessionSlot.addEventListener("change", updateMetaPreview);
      sessionCountInput.addEventListener("input", updateMetaPreview);
      sessionSeconds.addEventListener("input", updateMetaPreview);
      sessionTags.addEventListener("input", updateMetaPreview);

      goChatBtn.addEventListener("click", function () {
        const date = sessionDate.value.trim();
        const member = sessionMember.value.trim();
        if (!date || !member) {
          alert("è«‹å…ˆå¡«å¥½ã€Œæ—¥æœŸã€å’Œã€Œæˆå“¡åç¨±ã€ï¼Œå†é€²å…¥å°è©±é ã€‚");
          return;
        }
        showChatStep();
      });

      backBasicBtn.addEventListener("click", function () {
        showBasicStep();
      });

      openMsgModalBtn.addEventListener("click", openMsgModal);
      closeMsgModalBtn.addEventListener("click", closeMsgModal);
      cancelMsgBtn.addEventListener("click", closeMsgModal);

      addMsgBtn.addEventListener("click", function () {
        addMessage();
      });

      function handleMsgKey(e) {
        if ((e.ctrlKey || e.metaKey) && e.key === "Enter") {
          e.preventDefault();
          addMessage();
        }
      }

      msgTextJp.addEventListener("keydown", handleMsgKey);
      msgTextZh.addEventListener("keydown", handleMsgKey);

      clearMsgBtn.addEventListener("click", clearMessages);
      saveSessionBtn.addEventListener("click", function () {
        saveSession();
      });

      deleteSessionBtn.addEventListener("click", deleteSession);
      newSessionBtn.addEventListener("click", resetSessionForm);

      msgModal.addEventListener("click", function (e) {
        if (e.target === msgModal) {
          closeMsgModal();
        }
      });

      // ---- Init ----
      function init() {
        loadSettings();
        updateAvatarPreviews();

        records = loadRecords();
        renderSessionList();
        resetSessionForm();

        updateChatBackground();

        if (records.length) {
          const firstId = records[0].id;
          setActiveSession(firstId);
        }
      }

      init();
    })();
  </script>
</body>
</html>
