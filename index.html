<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sakurazaka46 ãƒŸãƒ¼ã‚°ãƒª</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dom-to-image-more@2.9.5/dist/dom-to-image-more.min.js"></script>

    <style>
/* è¨­å®šå€ï¼šå…©è¡Œå…©æ ¼ */
.config-grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-top: 8px;
}

.config-grid-2 select,
.config-grid-2 input {
    width: 100%;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid #ddd;
    font-size: 13px;
    box-sizing: border-box;
}

.date-input-wrap {
  position: relative;
}

.date-input-wrap input[type="date"] {
  position: relative;
  background: transparent;
}

.date-placeholder {
  position: absolute;
  left: .6rem;
  top: 50%;
  transform: translateY(-50%);
  color: #9ca3af;
  font-size: .85rem;
  pointer-events: none;
}
        :root { 
        --sakura-pink: #f4b4d0; 
        --text-gray: #8e8e93; 
        --nick-green: #2ecc71; 
        --bg-main: #f8f9fa; 
        /* å°è©±æ¡†é‚Šæ¡†æ¼¸å±¤ç”¨çš„å…©å€‹é¡è‰²ï¼ˆé è¨­ï¼šæ«»ç²‰ â†’ ç™½ï¼‰ */
        --bubble-c1: #ffb7c5;
        --bubble-c2: #ffffff;
      }

        * { box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { background: #333; margin: 0; display: flex; justify-content: center; overflow-x: hidden; }

        /* è¦–çª—åˆ‡æ› */
        .view-section { display: none; width: 450px; min-height: 100vh; background: white; position: relative; }
        .view-section.active { display: flex; flex-direction: column; }

        /* ä¸»ç•«é¢ */
        #main-dashboard { background: var(--bg-main); padding: 25px; }
        .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .add-record-btn { background: var(--sakura-pink); color: white; border: none; padding: 12px 25px; border-radius: 25px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(244,180,208,0.4); }
        .record-list { display: flex; flex-direction: column; gap: 15px; }
        .record-card { background: white; padding: 18px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .record-info .r-title { font-weight: bold; font-size: 1.1rem; color: #333; }
        .record-info .r-meta { font-size: 0.85rem; color: #999; margin-top: 5px; }
        .btn-del { color: #ff3b30; border: none; background: none; padding: 10px; cursor: pointer; }

        /* ç·¨è¼¯é è¦½å€ */
        #capture-area { padding: 20px 20px 100px; flex-grow: 1; background: white; }
.header-center {
  position: relative;
  text-align: center;

  padding-bottom: 14px;         /* header å…§éƒ¨åº•éƒ¨ç•™ä¸€é»ç©ºé–“ */
  margin-bottom: 20px;          /* header èˆ‡ç¬¬ä¸€å€‹å°è©±æ³¡æ³¡çš„è·é›¢ï¼Œè¦ºå¾—ä¸å¤ å¯ä»¥å†åŠ å¤§ */

  border-bottom: 1px solid #f2f2f7;
}
        .avatar-container { width: 85px; height: 85px; border-radius: 50%; overflow: hidden; margin: 0 auto 10px; border: 2px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; }
        .header-avatar { width: 100%; height: 100%; object-fit: cover; }
        .header-name { font-size: 20px; font-weight: bold; margin: 0; }
        .header-date { font-size: 12px; color: var(--text-gray); margin-top: 2px; }
        .nick-label { font-size: 11px; margin-top: 5px; color: #333; }
        .header-nick { font-size: 18px; font-weight: bold; color: var(--nick-green); margin-top: 0; }
.status-corner {
  position: absolute;
  right: 0;
  bottom: 20px;                 /* å¾€ä¸ŠæŠ“ä¸€é»ï¼Œå¤§æ¦‚å°åœ¨æš±ç¨±é‚£ä¸€è¡Œé™„è¿‘ */
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 2px;
  font-size: 11px;
  color: var(--text-gray);
}

/* ä¸è¦è®“ã€ŒğŸ« 3 æšã€ã€Œâ±ï¸ 30 ç§’ã€è¢«æ‹†è¡Œ */
.status-corner > div {
  white-space: nowrap;
}

/* å°è©±åˆ—è¡¨ */
.chat-list {
  display: flex;
  flex-direction: column;
  gap: 6px;
}
        .chat-item { display: flex; align-items: flex-start; width: 100%; position: relative; gap: 4px; }
        .item-member { align-self: flex-start; }
        .item-fan { align-self: flex-end; flex-direction: row-reverse; }
        .chat-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .item-member .chat-avatar { margin-right: 12px; }
        .item-fan .chat-avatar { margin-left: 12px; }
        .bubble { padding: 6px 10px; font-size: 13px; border-radius: 14px; line-height: 1.28; border: 1px solid transparent; }
       :root {
  --member-c1: #ffe9f3;
  --member-c2: #ffffff;
  --fan-c1: #e9f0ff;
  --fan-c2: #f4f4f4;
}

/* å°è©±æ³¡æ³¡ï¼šå­—å¤ªé•·æ™‚æ›è¡Œï¼Œè€Œä¸”ä¸è¦æ‹‰å¤ªå¯¬ */
.chat-item .bubble {
  max-width: 65%;            
  overflow-wrap: break-word; /* é¿å…è‹±æ–‡æˆ–é•·å­—ä¸²è¶…å‡º */
  word-break: break-word;
}


.item-member .bubble {
        padding: 11px 16px;
        border-radius: 18px;
        border-top-left-radius: 4px;
        background:
            /* å…§éƒ¨åº•è‰² */
            linear-gradient(#ffffff, #ffffff) padding-box,
            /* å¤–åœˆæ¼¸å±¤é‚Šæ¡† */
            linear-gradient(135deg, var(--bubble-c1), var(--bubble-c2)) border-box;
        border: 2px solid transparent;
}

.item-fan .bubble {
        padding: 11px 16px;
        border-radius: 18px;
        border-top-right-radius: 4px;
        background:
            linear-gradient(#f7f7f7, #f7f7f7) padding-box,
            linear-gradient(135deg, var(--bubble-c1), var(--bubble-c2)) border-box;
        border: 2px solid transparent;
}

/* å°è©±é•·æŒ‰çš„é¸å–®ï¼ˆç·¨è¼¯ / åˆªé™¤ï¼‰ */
.chat-menu {
  position: fixed;
  left: 50%;
  bottom: 20px;
  transform: translateX(-50%);
  padding: 8px 12px;
  border-radius: 12px;
  background: #fff;
  box-shadow: 0 8px 24px rgba(0,0,0,0.18);
  display: none;
  gap: 8px;
  z-index: 999;
}

.chat-menu button {
  border: none;
  padding: 6px 12px;
  border-radius: 8px;
  font-size: 14px;
  cursor: pointer;
}

.chat-menu button:first-child {
  background: #f4f4f6;         /* ç·¨è¼¯ */
}

.chat-menu button:last-child {
  background: #ffecec;         /* åˆªé™¤ */
  color: #c0392b;
}


        .no-avatar { margin-left: 57px; }
        .item-fan.no-avatar { margin-right: 57px; margin-left: 0; }
        .item-other { align-self: center; justify-content: center; width: 100%; margin: 8px 0; }
        .item-other .bubble { background: transparent; color: #ced4da; font-size: 12px; text-align: center; border: none; }

        /* è£å‰ª */
        #crop-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; }
        .crop-viewport { width: 300px; height: 300px; border: 1px solid #fff; position: relative; overflow: hidden; }
        .crop-circle-mask { position: absolute; width: 100%; height: 100%; border-radius: 50%; box-shadow: 0 0 0 1000px rgba(0,0,0,0.5); z-index: 3; pointer-events: none; }
        #preview-img-raw { position: absolute; cursor: move; touch-action: none; }

        /* æ§åˆ¶é¢æ¿ */
        .drawer { position: fixed; bottom: -100%; left: 50%; transform: translateX(-50%); width: 100%; max-width: 450px; background: white; transition: 0.3s; z-index: 500; border-radius: 20px 20px 0 0; padding: 15px 20px; box-shadow: 0 -5px 25px rgba(0,0,0,0.2); }
        .drawer.active { bottom: 0; }
        input, select, textarea { width: 100%; padding: 8px 10px; margin-bottom: 6px; font-size: 14px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; }
        .config-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }
        .drawer-btn-group { display: flex; gap: 8px; margin-bottom: 10px; }
        .drawer-btn-group button { flex: 1; padding: 8px; font-size: 13px; border-radius: 6px; border: 1px solid #eee; background: white; cursor: pointer; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; max-width: 450px; background: white; display: flex; justify-content: space-around; padding: 12px; border-top: 1px solid #eee; z-index: 300; }
        .nav-btn { background: none; border: none; font-size: 11px; cursor: pointer; color: #666; }
        .back-nav { background: #eee; padding: 10px; display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 13px; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 400; }
    .fab-add {
  position: fixed;
  right: 20px;
  bottom: 20px;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  border: none;
  background: var(--sakura-pink);
  color: #fff;
  font-size: 32px;
  line-height: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.18);
  cursor: pointer;
  z-index: 1000;
}
#edit-view .fab-add {
  display: none;
}
body.in-edit .fab-add {
  display: none;
}
.fab-add:active {
  transform: scale(0.96);
}

/* æ¡Œæ©Ÿç¨å¾®å¾€ä¸Š / å¾€è£¡ç¸®ä¸€é» */
@media (min-width: 768px) {
  .fab-add {
    right: 32px;
    bottom: 32px;
  }
}
/* æ¨™é¡Œ + ä¸Šæ–¹å·¥å…·åˆ— */
.dash-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}

.app-title {
  margin: 0;
}


/* ä¸Šæ–¹æŒ‰éˆ•åˆ— */
.dash-actions {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

/* å°é¡†çš„ chip æ¨£å¼ï¼Œä¸è¦åƒå¤§åœ“æŒ‰éˆ•é‚£éº¼åšé‡ */
.top-btn {
  padding: 4px 12px;
  border-radius: 999px;
  border: 1px solid #f9c3de;
  background: #fff;
  color: #ff7fb2;
  font-size: 12px;
  line-height: 1.4;
  cursor: pointer;
  box-shadow: none;
  white-space: nowrap;
}

/* ä¸»è¦æŒ‰éˆ•ï¼ˆCSVï¼‰ç¨å¾®å¡«è‰²ï¼Œç•¶ä¸»è§’ */
.top-btn-primary {
  background: var(--sakura-pink);
  color: #fff;
  border-color: var(--sakura-pink);
}

/* é»ä¸‹å»æœ‰ä¸€é»ç¸®æ”¾å›é¥‹ */
.top-btn:active {
  transform: scale(0.96);
}

/* å°è¢å¹•è®“æŒ‰éˆ•é å³ï¼Œå¿…è¦æ™‚å¯ä»¥è‡ªå‹•æ›è¡Œ */
@media (max-width: 480px) {
  .dash-actions {
    flex: 1;
    justify-content: flex-end;
  }
}

</style>
</head>
<body>

<div id="main-dashboard" class="view-section active">
<div class="dash-header">
  <h2 class="app-title">ğŸŒ¸ãƒŸãƒ¼ã‚°ãƒª</h2>

  <div class="dash-actions">
    <!-- åŒ¯å‡ºåˆ° Notion çš„ CSVï¼ˆä¸»æŒ‰éˆ•ï¼‰ -->
    <button class="top-btn top-btn-primary"
            type="button"
            onclick="exportToNotionCSV()">
      CSV
    </button>

    <!-- åŒ¯å‡ºå‚™ä»½ JSON -->
    <button class="top-btn"
            type="button"
            onclick="exportBackup()">
      å‚™ä»½â†“
    </button>

    <!-- åŒ¯å…¥å‚™ä»½ JSON -->
    <button class="top-btn"
            type="button"
            onclick="triggerBackupImport()">
      å‚™ä»½â†‘
    </button>

    <!-- åŒ¯å…¥å‚™ä»½ç”¨çš„éš±è— input -->
    <input type="file"
           id="backup-input"
           accept="application/json"
           style="display:none"
           onchange="importBackup(this.files)">
  </div>
</div>
<div class="main-view">
  <!-- ğŸ”½ æ–°å¢ï¼šæ’åºé¸å–®ï¼ˆå°±åœ¨ record-list ä¸Šé¢ï¼‰ -->
  <div style="display:flex; justify-content:flex-end; margin:8px 0;">
    <select id="sort-select" onchange="renderRecordList()" style="font-size:13px;">
      <option value="date-desc">ğŸ“… æ—¥æœŸï¼ˆæ–° â†’ èˆŠï¼‰</option>
      <option value="date-asc">ğŸ“… æ—¥æœŸï¼ˆèˆŠ â†’ æ–°ï¼‰</option>
    </select>
  </div>

  <div id="record-list"></div>

</div>

</div>

<div id="edit-view" class="view-section">
    <div class="back-nav" onclick="backToDash()">â¬… è¿”å›ä¸»ç•«é¢</div>
    <div id="capture-area">
        <div class="header-center">
            <div class="avatar-container" onclick="triggerFile('member')">
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==" id="prev-img-member" class="header-avatar">
            </div>
            <div id="prev-name" class="header-name">æˆå“¡</div>
            <div id="prev-date" class="header-date">æ—¥æœŸ</div>
            <div class="nick-label">ğŸ‘¤ ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </div>
            <div id="prev-nick" class="header-nick">æš±ç¨±</div>
            <div class="status-corner">
                <div id="prev-part"></div>
                <div id="prev-cards"></div>
                <div id="prev-seconds"></div>
            </div>
        </div>
        <div class="chat-list" id="chat-list"></div>
    </div>
    <div class="bottom-nav">
        <button class="nav-btn" onclick="openDrawer('configDrawer')">âš™ï¸è¨­å®š</button>
        <button class="nav-btn" onclick="openDrawer('chatDrawer')">ğŸ’¬å°è©±</button>
        <button class="nav-btn" onclick="takeShot()" style="color:var(--sakura-pink); font-weight:bold;">ğŸ“¸æˆªåœ–</button>
    </div>
</div>

<div id="crop-modal">
    <div class="crop-viewport"><img id="preview-img-raw" src=""><div class="crop-circle-mask"></div></div>
    <div style="margin-top:30px; display:flex; gap:20px;">
        <button onclick="closeCrop()" style="color:white; background:none; border:1px solid #fff; padding:10px 20px; border-radius:20px;">å–æ¶ˆ</button>
        <button onclick="confirmCrop()" style="background:white; border:none; padding:10px 20px; border-radius:20px;">ç¢ºå®š</button>
    </div>
</div>

<div class="overlay" id="overlay" onclick="closeAllDrawers()"></div>

<div class="drawer" id="configDrawer">
    <h3>âš™ï¸ è³‡æ–™è¨­å®š</h3>

    <div class="drawer-btn-group">
        <button onclick="triggerFile('member')">æˆå“¡ç›¸ç‰‡</button>
        <button onclick="triggerFile('fan')">æˆ‘çš„ç›¸ç‰‡</button>
    </div>

    <input type="file" id="real-file-input" style="display:none" onchange="handleFile(this)">

    <input type="text" id="input-name" placeholder="æˆå“¡å§“å" oninput="liveUpdate()">
    <input type="text" id="input-nick" placeholder="ä½ çš„æš±ç¨±" oninput="liveUpdate()">
    <input type="text" id="input-single" placeholder="å–®æ›²/å°ˆè¼¯åç¨±" oninput="autoSave()">

    <div class="date-input-wrap">
        <span class="date-placeholder" id="date-placeholder">é¸æ“‡æ—¥æœŸ</span>
        <input type="date" id="input-date" oninput="liveUpdate()">
    </div>

    <!-- è¨­å®šï¼šå…©è¡Œå…©æ ¼ -->
    <div class="config-grid-2">
        <!-- ç¬¬ 1 è¡Œï¼šé¡å‹ + éƒ¨æ•¸ -->
        <select id="input-type" onchange="liveUpdate()">
            <option value="">é¡å‹</option>
            <option value="ç·šæ¡">ç·šæ¡</option>
            <option value="å…¨æ¡">å…¨æ¡</option>
            <option value="å¯¦é«”">å¯¦é«”</option>
        </select>

        <select id="input-part" onchange="liveUpdate()">
            <option value="">éƒ¨æ•¸</option>
            <option value="ç¬¬1éƒ¨">ç¬¬1éƒ¨</option>
            <option value="ç¬¬2éƒ¨">ç¬¬2éƒ¨</option>
            <option value="ç¬¬3éƒ¨">ç¬¬3éƒ¨</option>
            <option value="ç¬¬4éƒ¨">ç¬¬4éƒ¨</option>
            <option value="ç¬¬5éƒ¨">ç¬¬5éƒ¨</option>
            <option value="ç¬¬6éƒ¨">ç¬¬6éƒ¨</option>
        </select>

        <!-- ç¬¬ 2 è¡Œï¼šæšæ•¸ + ç§’æ•¸ -->
        <input type="text" id="input-cards" placeholder="æšæ•¸" oninput="liveUpdate()">
        <input type="text" id="input-seconds" placeholder="ç§’æ•¸" oninput="liveUpdate()">
    </div>

    <!-- å°è©±æ¡†æ¼¸å±¤é¡è‰²ï¼šå¾æ«»å‚46 æ‡‰æ´è‰² 15 è‰²ä¸­é¸ 2 å€‹ -->
    <!-- å°è©±æ¡†æ¼¸å±¤é¡è‰²ï¼šæ”¹æˆèª¿è‰²ç›¤è‡ªé¸ -->
    <div style="margin-top:12px;">
        <div style="font-size:13px; margin-bottom:6px; color:#666;">å°è©±æ¡†æ¼¸å±¤é¡è‰²</div>
        <div style="display:flex; gap:8px; align-items:center;">
            <div style="flex:1;">
                <div style="font-size:12px; color:#999; margin-bottom:4px;">èµ·é»è‰²</div>
                <input type="color"
                       id="bubble-color-1"
                       value="#ffb7c5"
                       onchange="updateBubbleColors()"
                       style="width:100%; height:36px; padding:0; border-radius:8px; border:1px solid #ddd;">
            </div>

            <div style="flex:1;">
                <div style="font-size:12px; color:#999; margin-bottom:4px;">çµ‚é»è‰²</div>
                <input type="color"
                       id="bubble-color-2"
                       value="#ffffff"
                       onchange="updateBubbleColors()"
                       style="width:100%; height:36px; padding:0; border-radius:8px; border:1px solid #ddd;">
            </div>
        </div>
    </div>

    <!-- è³‡æ–™è¨­å®šç¢ºèª / å–æ¶ˆ -->
    <div style="display:flex; gap:8px; margin-top:8px;">
        <button onclick="confirmConfig()"
                style="flex:1; padding:10px; border-radius:8px; border:none;
                       background:var(--sakura-pink); color:#fff; font-size:14px;">
            ç¢ºèª
        </button>
        <button onclick="closeAllDrawers()"
                style="flex:1; padding:10px; border-radius:8px; border:1px solid #ddd;
                       background:#fff; font-size:14px;">
            å–æ¶ˆ
        </button>
    </div>
</div>

<div class="drawer" id="chatDrawer">
    <h3>ğŸ’¬ æ–°å¢å°è©±</h3>
    <textarea id="input-msg" rows="3" placeholder="è¼¸å…¥å°è©±å…§å®¹..."></textarea>
    <div style="display:flex; gap:10px;">
        <button onclick="addChat('member')" style="flex:1; padding:12px; background:white; border:1px solid #ddd; border-radius:8px;">æˆå“¡</button>
        <button onclick="addChat('fan')" style="flex:1; padding:12px; background:white; border:1px solid #ddd; border-radius:8px;">æˆ‘</button>
        <button onclick="addChat('other')" style="flex:1; padding:12px; background:#dcdde1; border:none; border-radius:8px;">å…¶ä»–</button>
    </div>
</div>

<script>


function escapeHTML(str) {
    return String(str).replace(/[&<>"']/g, function (m) {
        return ({
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;'
        })[m];
    });
}

    let currentRecordId = null;
    let mAv = "", fAv = "", lastT = "";
    let uploadTarget = "";
// åŒæ­¥æ›´æ–°èŠå¤©å€å°é ­åƒ
function syncChatAvatars() {
    const chatList = document.getElementById('chat-list');
    if (!chatList) return;

    // æ›´æ–°æˆå“¡ï¼ˆå·¦å´ï¼‰çš„é ­åƒ
    if (mAv) {
        chatList
          .querySelectorAll('.item-member .chat-avatar')
          .forEach(img => { img.src = mAv; });
    }

    // æ›´æ–°è‡ªå·±ï¼ˆå³å´ï¼‰çš„é ­åƒ
    if (fAv) {
        chatList
          .querySelectorAll('.item-fan .chat-avatar')
          .forEach(img => { img.src = fAv; });
    }
}


    let dbCache = [];             // å–ä»£åŸæœ¬ localStorage çš„å¿«å–
    let idb = null;               // IndexedDB å¯¦éš›é€£ç·š
    // ===== è£åˆ‡é è¦½ï¼šæ‹–æ›³ + é›™æŒ‡ç¸®æ”¾ =====
    const rawI = document.getElementById('preview-img-raw');
    let cropImgLoaded = false;
    let imgPosX = 0;
    let imgPosY = 0;
    let imgScale = 1;
    let isDragging = false;
    let dragStartX = 0;
    let dragStartY = 0;
    let imgStartX = 0;
    let imgStartY = 0;
    let lastPinchDist = 0;

    function updateCropTransform() {
        // ä»¥ transform è™•ç†ä½ç§» + ç¸®æ”¾
        rawI.style.transform = `translate(${imgPosX}px, ${imgPosY}px) scale(${imgScale})`;
    }

    function getDB() {
        // ä¹‹å¾Œæ‰€æœ‰ç¨‹å¼éƒ½å¾é€™è£¡æ‹¿è³‡æ–™
        return dbCache;
    }

    function setDBCache(db) {
        dbCache = Array.isArray(db) ? db : [];
    }

    function saveDB(db) {
        // æ›´æ–°è¨˜æ†¶é«”å¿«å–
        setDBCache(db);

        // å„²å­˜åˆ° IndexedDB
        if (idb) {
            try {
                const tx = idb.transaction('records', 'readwrite');
                const store = tx.objectStore('records');
                store.put({ id: 'dbArray', value: dbCache });
            } catch (e) {
                console.warn('å¯«å…¥ IndexedDB å¤±æ•—ï¼š', e);
            }
        } else {
            // é˜²å‘†å‚™ç”¨ï¼šè¬ä¸€ IndexedDB é–‹ä¸èµ·ä¾†ï¼Œå†é€€å› localStorageï¼ˆå®¹é‡é‚„æ˜¯æœ‰å¯èƒ½ä¸å¤ ï¼‰
            try {
                localStorage.setItem('sakura_v10_db', JSON.stringify(dbCache));
            } catch (e) {
                console.warn('å¯«å…¥ localStorage å¤±æ•—ï¼š', e);
            }
        }
    }

    function initIndexedDB() {
        if (!('indexedDB' in window)) {
            console.warn('ç€è¦½å™¨ä¸æ”¯æ´ IndexedDBï¼Œæ”¹ç”¨ localStorageã€‚');
            setDBCache(JSON.parse(localStorage.getItem('sakura_v10_db') || "[]"));
            renderRecordList();
            return;
        }

        const request = indexedDB.open('sakura_meetlog_db_v1', 1);

        request.onupgradeneeded = function () {
            const db = request.result;
            if (!db.objectStoreNames.contains('records')) {
                db.createObjectStore('records', { keyPath: 'id' });
            }
        };

        request.onsuccess = function () {
            idb = request.result;
            const tx = idb.transaction('records', 'readonly');
            const store = tx.objectStore('records');
            const getReq = store.get('dbArray');

            getReq.onsuccess = function () {
                const data = getReq.result && Array.isArray(getReq.result.value)
                    ? getReq.result.value
                    : [];
                setDBCache(data);
                renderRecordList();     // è¼‰å…¥å®Œæˆå¾Œå†ç•«åˆ—è¡¨
            };

            getReq.onerror = function () {
                console.warn('è®€å– IndexedDB å¤±æ•—ï¼š', getReq.error);
                setDBCache([]);
                renderRecordList();
            };
        };

        request.onerror = function () {
            console.warn('é–‹å•Ÿ IndexedDB å¤±æ•—ï¼š', request.error);
            // é€€å› localStorageï¼ˆå¦‚æœä¹‹å‰æœ‰å­˜ï¼‰
            setDBCache(JSON.parse(localStorage.getItem('sakura_v10_db') || "[]"));
            renderRecordList();
        };
    }

function renderRecordList() {
    document.body.classList.remove('in-edit');

    const db = getDB();
    const container = document.getElementById('record-list');
    if (!container) return;

    container.innerHTML = '';

    if (!db || db.length === 0) {
        container.innerHTML =
            '<p style="text-align:center; color:#999; margin-top:20px;">ç›®å‰æ²’æœ‰è¨˜éŒ„ã€‚</p>';
        return;
    }

    // è®€å–æ’åºé¸é …
    const sortSelect = document.getElementById('sort-select');
    const sortMode = sortSelect ? sortSelect.value : 'date-desc';

    // å…ˆè¤‡è£½ä¸€ä»½è³‡æ–™é¿å…ç›´æ¥æ”¹åˆ° db
    const records = [...db];

    // ç”¨æ—¥æœŸæ’åºï¼ˆæ”¯æ´ã€Œyyyy-mm-ddã€æˆ–ã€Œ2025å¹´1æœˆ10æ—¥ã€ï¼‰
    records.sort((a, b) => {
        const daStr = normalizeDateForInput(a.date || "");
        const dbStr = normalizeDateForInput(b.date || "");

        const da = daStr ? Date.parse(daStr) : 0;
        const dbt = dbStr ? Date.parse(dbStr) : 0;

        if (sortMode === 'date-asc') {
            // èˆŠ â†’ æ–°
            return da - dbt;
        } else {
            // æ–° â†’ èˆŠï¼ˆé è¨­ï¼‰
            return dbt - da;
        }
    });

    // ä¾ç…§æ’åºå¥½çš„ records ç•«å‡ºå¡ç‰‡
    records.forEach(r => {
        const card = document.createElement('div');
        card.className = 'record-card';

        // é»æ•´å¼µå¡ç‰‡ â†’ é€²å…¥å°è©±é é¢
        card.onclick = () => loadEditView(r.id);

        // å·¦é‚Šè³‡è¨Šå€
        const info = document.createElement('div');
        info.className = 'record-info';

        const title = document.createElement('div');
        title.className = 'r-title';
        title.innerHTML =
            (r.name || 'æˆå“¡') +
            (r.single
                ? ` <span style="font-size:0.8rem; color:var(--sakura-pink);">[${r.single}]</span>`
                : '');

        const meta = document.createElement('div');
        meta.className = 'r-meta';
        const parts = [];
        parts.push(r.date || 'ç„¡æ—¥æœŸ');
        if (r.type) parts.push(r.type);
        if (r.part) parts.push(r.part);
        meta.textContent = parts.join(' | ');

        info.appendChild(title);
        info.appendChild(meta);

        // å³é‚Šï¼šâ˜… å‹¾é¸ / ğŸ—‘ åˆªé™¤
        const actions = document.createElement('div');
        actions.className = 'card-actions';

        const markBtn = document.createElement('button');
        markBtn.type = 'button';
        markBtn.className = 'btn-mark';
        markBtn.textContent = r.selected ? 'â˜…' : 'â˜†';
        markBtn.title = 'å‹¾é¸è¦åŒ¯å‡ºçš„ç´€éŒ„';
        markBtn.onclick = (e) => {
            e.stopPropagation();
            // åˆ°çœŸæ­£çš„ db è£¡æ‰¾åˆ°åŒä¸€ç­†è³‡æ–™ï¼Œåˆ‡æ› selected
            const real = db.find(item => item.id === r.id);
            if (real) {
                real.selected = !real.selected;
                saveDB(db);
                renderRecordList();
            }
        };

        const delBtn = document.createElement('button');
        delBtn.type = 'button';
        delBtn.className = 'btn-del';
        delBtn.innerHTML = 'ğŸ—‘ï¸';
        delBtn.title = 'åˆªé™¤é€™ç­†ç´€éŒ„';
        delBtn.onclick = (e) => {
            e.stopPropagation();
            deleteRecord(r.id);
        };

        actions.appendChild(markBtn);
        actions.appendChild(delBtn);

        card.appendChild(info);
        card.appendChild(actions);

        container.appendChild(card);
    });
}

function createNewRecord() {
    const id = Date.now();
    const db = getDB();
    const defaultNick = localStorage.getItem('default_nickname') || "";

        db.push({
        id,
        name: "",
        single: "",
        date: "",
        type: "",
        part: "",
        chats: "",
        mAv: "",
        fAv: "",
        nick: defaultNick,
        cards: "",
        seconds: "",
        selected: false,
        bubbleC1: "#ffe9f3",   // é€™ä¸€å ´çš„é¡è‰²èµ·é»
        bubbleC2: "#ffffff"    // é€™ä¸€å ´çš„é¡è‰²çµ‚é»
    });


    saveDB(db);
    loadEditView(id);      // ç«‹åˆ»é€²å…¥å°è©±ç·¨è¼¯ç•«é¢
}

    function deleteRecord(id) {
        if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) return;
        let db = getDB();
    db = db.filter(item => item.id !== id);
    saveDB(db);
    renderRecordList();
    }

function normalizeDateForInput(val) {
    if (!val) return "";

    // å·²ç¶“æ˜¯ yyyy-MM-dd
    if (/^\d{4}-\d{2}-\d{2}$/.test(val)) return val;

    // ä¸­æ–‡æ—¥æœŸï¼š2025å¹´12æœˆ22æ—¥
    const m = val.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
    if (m) {
        const y = m[1];
        const mo = String(m[2]).padStart(2, '0');
        const d = String(m[3]).padStart(2, '0');
        return `${y}-${mo}-${d}`;
    }

    return "";
}

    function loadEditView(id) {
    document.body.classList.add('in-edit');
    currentRecordId = id;
    const db = getDB();
    const r = db.find(item => item.id === id);
    
    // å¡«å……è¨­å®šæ¬„ä½
const setVal = (id, val) => {
    const el = document.getElementById(id);
    if (!el) return;
    el.value = val || "";
};

    setVal('input-single', r.single);
    setVal('input-name', r.name);
    setVal('input-nick', r.nick);
    setVal('input-date', r.date);
    setVal('input-type', r.type);
    setVal('input-part', r.part);
    setVal('input-cards', r.cards);
    setVal('input-seconds', r.seconds);

    // è¼‰å…¥å®Œæ•´çš„å°è©±æ¸…å–®
const chatListEl = document.getElementById('chat-list');
chatListEl.innerHTML = r.chats || "";

// ğŸ”¹ æ¸…æ‰èˆŠç‰ˆæœ¬ç•™ä¸‹çš„ X æŒ‰éˆ•
chatListEl.querySelectorAll('.chat-delete').forEach(el => el.remove());

// é‡æ–°æ›ä¸Šé•·æŒ‰äº‹ä»¶
initChatLongPress();
    // è®€å–é ­åƒæ•¸æ“š
    mAv = r.mAv || ""; 
    fAv = r.fAv || "";
   const c1Input = document.getElementById('bubble-color-1');
    const c2Input = document.getElementById('bubble-color-2');
    if (c1Input && c2Input) {
        c1Input.value = r.bubbleC1 || '#ffb7c5';
        c2Input.value = r.bubbleC2 || '#ffffff';
        updateBubbleColors(true);  // fromLoad = true â†’ ä¸å¦å¤–å­˜æª”
    }

    document.getElementById('prev-img-member').src = mAv || "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==";
    syncChatAvatars();
    liveUpdate();
    
    // åˆ‡æ›è¦–çª—
    document.getElementById('main-dashboard').classList.remove('active');
    document.getElementById('edit-view').classList.add('active');
}

// å°‡èŠå¤© HTML è½‰æˆç´”æ–‡å­—ï¼ˆçµ¦ Notion ç”¨ï¼‰
// æœƒè¼¸å‡ºé¡ä¼¼ï¼š
// æˆå“¡ï¼šä¹…ã—ã¶ã‚Š
// æˆ‘ï¼šãŠèª•ç”Ÿæ—¥ãŠã‚ã§ã¨ã†
// ä¸­é–“æè¿°ï¼šâ€¦â€¦
function chatsHTMLToPlainText(html) {
    if (!html) return "";
    const container = document.createElement("div");
    container.innerHTML = html;
    const items = container.querySelectorAll(".chat-item");
    const lines = [];

    items.forEach(item => {
        const bubble = item.querySelector(".bubble");
        if (!bubble) return;
        const text = bubble.innerText.trim();
        if (!text) return;

        if (item.classList.contains("item-member")) {
            lines.push("æˆå“¡ï¼š" + text);
        } else if (item.classList.contains("item-fan")) {
            lines.push("æˆ‘ï¼š" + text);
        } else {
            // å…¶ä»–é¡å‹ï¼ˆæè¿°æƒ…å¢ƒç­‰ï¼‰ï¼Œç›´æ¥å¡æ–‡å­—
            lines.push(text);
        }
    });

    return lines.join("\n");
}

// CSV æ¬„ä½è½‰ç¾©ï¼ˆç¢ºä¿é€—è™Ÿã€æ›è¡Œåœ¨ Notion ä¹Ÿèƒ½æ­£ç¢ºè®€ï¼‰
function csvEscape(str) {
    if (str === null || str === undefined) return '""';
    const s = String(str).replace(/"/g, '""');
    // ä¸€å¾‹åŠ é›™å¼•è™Ÿï¼Œé¿å…é€—è™Ÿ / æ›è¡Œå•é¡Œ
    return `"${s}"`;
}

// åŒ¯å‡ºç›®å‰æ‰€æœ‰ç´€éŒ„æˆ Notion å¯åŒ¯å…¥çš„ CSV
function exportToNotionCSV() {
    const all = getDB();
    const db = all.filter(r => r.selected);

    if (!db.length) {
        alert("è«‹å…ˆåœ¨åˆ—è¡¨ç”¨ â˜… å‹¾é¸è¦åŒ¯å‡ºçš„ç´€éŒ„");
        return;
    }

    const header = [
        "æ—¥æœŸ",
        "å–®æ›²/å°ˆè¼¯åç¨±",
        "éƒ¨æ•¸",
        "æšæ•¸",
        "ç§’æ•¸",
        "é¡å‹",
        "å°è©±"
    ];

    const rows = [];
    rows.push(header.map(csvEscape).join(","));

    // æ¯ä¸€ç­†è¨˜éŒ„ä¸€è¡Œ
    db.forEach(r => {
        const dialog = chatsHTMLToPlainText(r.chats || "");

        const cols = [
            r.date || "",
            r.single || "",
            r.part || "",
            r.cards || "",
            r.seconds || "",
            r.type || "",
            dialog
        ].map(csvEscape);

        rows.push(cols.join(","));
    });

    const csvContent = rows.join("\r\n");
    const bom = "\uFEFF";
    const blob = new Blob([bom + csvContent], {
        type: "text/csv;charset=utf-8;"
    });

    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    const today = new Date().toISOString().slice(0, 10);
    a.href = url;
    a.download = `miguri_${today}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ğŸ”¹ åŒ¯å‡ºå‚™ä»½ï¼šæŠŠç›®å‰æ‰€æœ‰ç´€éŒ„å­˜æˆ JSON ä¸‹è¼‰
function exportBackup() {
    const db = getDB() || [];

    if (!db.length) {
        if (!confirm("ç›®å‰æ²’æœ‰ç´€éŒ„ï¼Œè¦åŒ¯å‡ºä¸€å€‹ç©ºçš„å‚™ä»½æª”å—ï¼Ÿ")) return;
    }

    // å¯ä»¥ç•™å€‹ç‰ˆæœ¬æ¬„ä½ï¼Œæœªä¾†æƒ³æ”¹æ ¼å¼æ¯”è¼ƒå¥½è™•ç†
    const payload = {
        version: 1,
        exportedAt: new Date().toISOString(),
        records: db
    };

    const json = JSON.stringify(payload);
    const blob = new Blob([json], { type: "application/json;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    const today = new Date().toISOString().slice(0, 10); // yyyy-mm-dd
    a.href = url;
    a.download = `miguri_${today}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

// ğŸ”¹ è§¸ç™¼éš±è—çš„ <input type="file">ï¼Œè®“ä½¿ç”¨è€…é¸å‚™ä»½æª”
function triggerBackupImport() {
    const input = document.getElementById("backup-input");
    if (input) {
        input.value = "";           // æ¸…æ‰ä¸Šä¸€æ¬¡é¸æ“‡
        input.click();
    }
}

// ğŸ”¹ åŒ¯å…¥å‚™ä»½ï¼šè®€ JSONï¼Œè¦†è“‹ç›®å‰è³‡æ–™
function importBackup(files) {
    const file = files && files[0];
    if (!file) return;

    if (!confirm("åŒ¯å…¥å‚™ä»½æœƒè¦†è“‹ç›®å‰è£ç½®ä¸Šçš„æ‰€æœ‰ç´€éŒ„ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ")) {
        return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const text = e.target.result;
            const data = JSON.parse(text);

            // åŒæ™‚æ”¯æ´å…©ç¨®æ ¼å¼ï¼š
            // 1) { version, records: [...] }
            // 2) ç›´æ¥å°±æ˜¯ Array
            const records = Array.isArray(data) ? data : data.records;

            if (!Array.isArray(records)) {
                alert("å‚™ä»½æª”æ ¼å¼ä¸æ­£ç¢ºï¼Œç„¡æ³•åŒ¯å…¥ã€‚");
                return;
            }

            // è¦†è“‹ç›®å‰ DB
            saveDB(records);
            renderRecordList();

            alert("åŒ¯å…¥å®Œæˆï¼å·²è¼‰å…¥ " + records.length + " ç­†ç´€éŒ„ã€‚");
        } catch (err) {
            console.error(err);
            alert("åŒ¯å…¥å¤±æ•—ï¼Œæª”æ¡ˆå…§å®¹å¯èƒ½å·²æå£æˆ–ä¸æ˜¯å‚™ä»½æª”ã€‚");
        }
    };

    reader.readAsText(file, "utf-8");
}

    function backToDash() {
    // 1. ç•°æ­¥åŸ·è¡Œå­˜æª”ï¼Œä¸é˜»å¡ç•«é¢åˆ‡æ›
    setTimeout(() => {
        try {
            autoSave();
        } catch(e) {
            console.warn("è‡ªå‹•å­˜æª”å»¶é²æˆ–å¤±æ•—", e);
        }
    }, 0);

    // 2. ç«‹å³åˆ‡æ› UI
    const editView = document.getElementById('edit-view');
    const dashView = document.getElementById('main-dashboard');
    
    if (editView && dashView) {
        editView.classList.remove('active');
        dashView.classList.add('active');
        // é‡æ–°æ¸²æŸ“æ¸…å–®
        renderRecordList(); 
    }
    
    // 3. é—œé–‰æ‰€æœ‰å¯èƒ½é–‹å•Ÿçš„é¢æ¿
    closeAllDrawers();
}

    function autoSave() {
    if(!currentRecordId) return;
    const db = getDB();
    const idx = db.findIndex(r => r.id === currentRecordId);
    if(idx === -1) return;
    
    const getVal = (id) => document.getElementById(id) ? document.getElementById(id).value : "";
    const nickValue = getVal('input-nick');

    // ç›´æ¥æŠ“å–æ•´å€‹å°è©±å®¹å™¨çš„ HTMLï¼Œç¢ºä¿ä¸é™è¡Œæ•¸å®Œæ•´å­˜æª”
    const chatContent = document.getElementById('chat-list').innerHTML;
    const c1Input = document.getElementById('bubble-color-1');
    const c2Input = document.getElementById('bubble-color-2');
    const bubbleC1 = c1Input ? c1Input.value : (db[idx].bubbleC1 || '#ffb7c5');
    const bubbleC2 = c2Input ? c2Input.value : (db[idx].bubbleC2 || '#ffffff');

       db[idx] = {
        ...db[idx],
        name: getVal('input-name'),
        single: getVal('input-single'),
        nick: nickValue,
        date: getVal('input-date'),
        type: getVal('input-type'),
        part: getVal('input-part'),
        cards: getVal('input-cards'),
        seconds: getVal('input-seconds'),
        chats: chatContent, // å­˜æª”æ‰€æœ‰å°è©±
        mAv: mAv,
        fAv: fAv,
        bubbleC1,
        bubbleC2
    };


    saveDB(db);
    
    // åŒæ™‚å„²å­˜é è¨­æš±ç¨±
    if(nickValue) localStorage.setItem('default_nickname', nickValue);
}

function confirmConfig() {
    // å†è·‘ä¸€æ¬¡ç•«é¢æ›´æ–°ï¼Œé¿å…æœ‰æ²’è§¸ç™¼åˆ° oninput çš„æ¬„ä½
    try {
        liveUpdate();
    } catch(e) {
        console.warn("liveUpdate ç™¼ç”ŸéŒ¯èª¤", e);
    }

    // å†å­˜ä¸€éï¼Œå¿ƒç†æ¯”è¼ƒå®‰å¿ƒ XD
    try {
        autoSave();
    } catch(e) {
        console.warn("autoSave ç™¼ç”ŸéŒ¯èª¤", e);
    }

    // é—œé–‰è¨­å®šé¢æ¿
    closeAllDrawers();
}

    function liveUpdate() {
        const getVal = (id) => document.getElementById(id) ? document.getElementById(id).value : "";
        document.getElementById('prev-name').innerText = getVal('input-name') || "æˆå“¡";
        document.getElementById('prev-nick').innerText = getVal('input-nick') || "æš±ç¨±";
        const dateVal = getVal('input-date');
        if (dateVal) {
            const dateObj = new Date(dateVal);
            const weekDay = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"][dateObj.getDay()];
            document.getElementById('prev-date').innerText = `${dateObj.getMonth() + 1}/${dateObj.getDate()}(${weekDay})`;
        } else {
            document.getElementById('prev-date').innerText = "æ—¥æœŸ";
        }
        document.getElementById('prev-part').innerText = getVal('input-part') || "";
        const cards = getVal('input-cards');
        document.getElementById('prev-cards').innerText = cards ? `ğŸ« ${cards} æš` : "";
        const seconds = getVal('input-seconds');
        document.getElementById('prev-seconds').innerText = seconds ? `â±ï¸ ${seconds} ç§’` : "";
        autoSave();
    }

function updateBubbleStyle() {

    // å­˜é€²ç›®å‰ç´€éŒ„ï¼ˆæˆ–å…¨åŸŸè¨­å®šï¼‰
    try { autoSave(); } catch(e){}
}


document.addEventListener('DOMContentLoaded', () => {
  const dateInput = document.getElementById('input-date');
  const datePlaceholder = document.getElementById('date-placeholder');

  function updateDatePlaceholder() {
    datePlaceholder.style.display = dateInput.value ? 'none' : 'block';
  }

  dateInput.addEventListener('change', updateDatePlaceholder);
  updateDatePlaceholder();
});

function addChat(type) {
    const msg = document.getElementById('input-msg').value.replace(/\s+$/,'');
    if (!msg) return;

    const list = document.getElementById('chat-list');
    const div = document.createElement('div');

    if (type === 'other') {
        div.className = 'chat-item item-other';
        div.innerHTML = `
            <div class="bubble">${msg.replace(/\n/g, '<br>')}</div>
        `;
    } else {
        const isC = (type === lastT);
        div.className = `chat-item item-${type} ${isC ? 'no-avatar' : ''}`;

        const avatar = (type === 'member') ? mAv : fAv;
        const finalAvatar =
          avatar ||
          "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==";

        div.innerHTML = `
            ${!isC ? `<img src="${finalAvatar}" class="chat-avatar">` : ''}
            <div class="bubble">${msg.replace(/\n/g, '<br>')}</div>
        `;
    }

    list.appendChild(div);
    lastT = type;
    document.getElementById('input-msg').value = '';

    // æ–°å¢çš„å°è©±ä¹Ÿæ›ä¸Šé•·æŒ‰äº‹ä»¶
    setupBubbleLongPress(div);

    autoSave();
}

    function triggerFile(t) { uploadTarget = t; document.getElementById('real-file-input').click(); }
    function handleFile(i) {
        const file = i.files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = e => { 
                const img = document.getElementById('preview-img-raw');
                img.src = e.target.result; 
                document.getElementById('crop-modal').style.display = 'flex'; 
                  img.onload = function() {
                    const scale = 300 / Math.min(img.naturalWidth, img.naturalHeight);
                    img.style.width  = (img.naturalWidth  * scale) + "px";
                    img.style.height = (img.naturalHeight * scale) + "px";

                    // åˆå§‹åŒ–ç¸®æ”¾ç‹€æ…‹ï¼ˆç½®ä¸­ + ç¸®æ”¾ 1ï¼‰
                    imgScale = 1;
                    imgPosX = 0;
                    imgPosY = 0;
                    cropImgLoaded = true;
                    updateCropTransform();
                };

            };
            reader.readAsDataURL(file);
        }
    }

        // æ»‘é¼ æ‹–æ›³
    rawI.addEventListener('mousedown', function (e) {
        if (!cropImgLoaded) return;
        isDragging = true;
        dragStartX = e.clientX;
        dragStartY = e.clientY;
        imgStartX = imgPosX;
        imgStartY = imgPosY;
    });

    window.addEventListener('mouseup', function () {
        isDragging = false;
    });

    window.addEventListener('mousemove', function (e) {
        if (!isDragging || !cropImgLoaded) return;
        const dx = e.clientX - dragStartX;
        const dy = e.clientY - dragStartY;
        imgPosX = imgStartX + dx;
        imgPosY = imgStartY + dy;
        updateCropTransform();
    });

    // æ‰‹æŒ‡ï¼šå–®æŒ‡æ‹–æ›³ + é›™æŒ‡ç¸®æ”¾
    rawI.addEventListener('touchstart', function (e) {
        if (!cropImgLoaded) return;
        if (e.touches.length === 1) {
            // å–®æŒ‡æ‹–æ›³
            const t = e.touches[0];
            isDragging = true;
            dragStartX = t.clientX;
            dragStartY = t.clientY;
            imgStartX = imgPosX;
            imgStartY = imgPosY;
            lastPinchDist = 0;
        } else if (e.touches.length === 2) {
            // é›™æŒ‡ç¸®æ”¾
            const [t1, t2] = e.touches;
            lastPinchDist = Math.hypot(
                t2.clientX - t1.clientX,
                t2.clientY - t1.clientY
            );
            isDragging = false;
        }
    }, { passive: false });

    rawI.addEventListener('touchmove', function (e) {
        if (!cropImgLoaded) return;
        if (e.touches.length === 1 && isDragging) {
            // å–®æŒ‡æ‹–æ›³
            const t = e.touches[0];
            const dx = t.clientX - dragStartX;
            const dy = t.clientY - dragStartY;
            imgPosX = imgStartX + dx;
            imgPosY = imgStartY + dy;
            updateCropTransform();
        } else if (e.touches.length === 2) {
            // é›™æŒ‡ç¸®æ”¾
            const [t1, t2] = e.touches;
            const dist = Math.hypot(
                t2.clientX - t1.clientX,
                t2.clientY - t1.clientY
            );
            if (lastPinchDist) {
                let factor = dist / lastPinchDist;
                let newScale = imgScale * factor;
                // é™åˆ¶ç¸®æ”¾ç¯„åœï¼ˆå¯ä¾å–œå¥½èª¿æ•´ï¼‰
                if (newScale < 1) newScale = 1;
                if (newScale > 3) newScale = 3;
                imgScale = newScale;
                updateCropTransform();
            }
            lastPinchDist = dist;
        }
        e.preventDefault();
    }, { passive: false });

    rawI.addEventListener('touchend', function () {
        if (!event.touches || event.touches.length === 0) {
            isDragging = false;
            lastPinchDist = 0;
        }
    });

let chatMenuTarget = null;   // ç›®å‰é•·æŒ‰çš„æ˜¯å“ªä¸€å€‹ chat-item
let menuJustOpened = false;  // é¿å…é•·æŒ‰æ”¾æ‰‹é‚£ä¸€ä¸‹å°±é—œæ‰

function openChatMenu(chatItem, rect) {
    chatMenuTarget = chatItem;
    const menu = document.getElementById('chat-menu');
    if (!menu) return;

    // è®“é¸å–®å‡ºç¾åœ¨ã€Œè©²æ°£æ³¡åº•ä¸‹ï¼Œç½®ä¸­ã€
    if (rect) {
        const top = rect.bottom + 6;                  // æ°£æ³¡åº•ä¸‹å†å¾€ä¸‹ 6px
        const centerX = rect.left + rect.width / 2;   // æ°£æ³¡çš„æ°´å¹³ä¸­å¿ƒ

        menu.style.top = top + 'px';
        menu.style.left = centerX + 'px';
        menu.style.bottom = 'auto';
        menu.style.transform = 'translateX(-50%)';
    }

    menu.style.display = 'flex';
    menuJustOpened = true;   // ç¬¬ä¸€å€‹ click å…ˆå¿½ç•¥
}

function closeChatMenu() {
    const menu = document.getElementById('chat-menu');
    if (menu) {
        menu.style.display = 'none';
        // å›åˆ°é è¨­ä½ç½®ï¼ˆé¿å…ä¸‹æ¬¡æ²’ rect æ™‚é‚„ç•™èˆŠåº§æ¨™ï¼‰
        menu.style.top = 'auto';
        menu.style.left = '50%';
        menu.style.bottom = '20px';
        menu.style.transform = 'translateX(-50%)';
    }
    chatMenuTarget = null;
    menuJustOpened = false;
}

// é•·æŒ‰ï¼šé–‹å•Ÿé¸å–®
function setupBubbleLongPress(chatItem) {
    const bubble = chatItem.querySelector('.bubble');
    if (!bubble) return;

    let pressTimer = null;

    const start = (e) => {
        if (pressTimer !== null) return;
        pressTimer = setTimeout(() => {
            const rect = bubble.getBoundingClientRect();
            openChatMenu(chatItem, rect);
            pressTimer = null;
        }, 600);   // é•·æŒ‰ 600ms
    };

    const cancel = () => {
        if (pressTimer !== null) {
            clearTimeout(pressTimer);
            pressTimer = null;
        }
    };

    bubble.addEventListener('mousedown', start);
    bubble.addEventListener('touchstart', start);
    ['mouseup', 'mouseleave', 'touchend', 'touchcancel'].forEach(ev => {
        bubble.addEventListener(ev, cancel);
    });
}

// é‡æ–°è¼‰å…¥èˆŠå°è©±æ™‚ï¼ŒæŠŠæ¯ä¸€å€‹ chat-item éƒ½æ›ä¸Šé•·æŒ‰
function initChatLongPress() {
    document
        .querySelectorAll('#chat-list .chat-item')
        .forEach(setupBubbleLongPress);
}

// é»ç•«é¢å…¶ä»–åœ°æ–¹å°±é—œæ‰é¸å–®
document.addEventListener('click', (e) => {
    const menu = document.getElementById('chat-menu');
    if (!menu || menu.style.display !== 'flex') return;

    // é•·æŒ‰æ”¾æ‰‹é‚£ä¸€ä¸‹æœƒè§¸ç™¼ç¬¬ä¸€æ¬¡ clickï¼Œå…ˆç•¥é
    if (menuJustOpened) {
        menuJustOpened = false;
        return;
    }

    // é»åœ¨é¸å–®è£¡å°±ä¸è¦é—œï¼ˆäº¤çµ¦æŒ‰éˆ•è‡ªå·±é—œï¼‰
    if (menu.contains(e.target)) return;

    // é»åœ¨åˆ¥çš„åœ°æ–¹æ‰é—œ
    closeChatMenu();
});

function editCurrentChat() {
    if (!chatMenuTarget) return;
    const bubble = chatMenuTarget.querySelector('.bubble');
    if (!bubble) {
        closeChatMenu();
        return;
    }

    // æŠŠ <br> æ›å› \nï¼Œè®“æ–‡å­—å¥½ç·¨è¼¯
    const oldText = bubble.innerHTML.replace(/<br\s*\/?>/gi, '\n');
    const newText = prompt('ç·¨è¼¯é€™å‰‡å°è©±ï¼š', oldText);

    if (newText !== null) {
        bubble.innerHTML = escapeHTML(newText).replace(/\n/g, '<br>');
        autoSave();
    }

    closeChatMenu();
}

function deleteCurrentChat() {
    if (!chatMenuTarget) return;
    if (!confirm('è¦åˆªé™¤é€™å‰‡å°è©±å—ï¼Ÿ')) {
        closeChatMenu();
        return;
    }

    chatMenuTarget.remove();
    autoSave();
    closeChatMenu();
}


// é‡æ–°è¼‰å…¥èˆŠå°è©±æ™‚ï¼ŒæŠŠæ¯ä¸€å€‹ chat-item éƒ½æ›ä¸Šé•·æŒ‰
function initChatLongPress() {
    document
        .querySelectorAll('#chat-list .chat-item')
        .forEach(setupBubbleLongPress);
}


    function confirmCrop() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const targetSize = 200;
        canvas.width = targetSize; canvas.height = targetSize;
        const img = document.getElementById('preview-img-raw');
        const rect = img.getBoundingClientRect();
        const viewport = document.querySelector('.crop-viewport').getBoundingClientRect();
        const scaleX = img.naturalWidth / rect.width;
        const scaleY = img.naturalHeight / rect.height;
        const x = (viewport.left - rect.left) * scaleX;
        const y = (viewport.top - rect.top) * scaleY;
        const width = viewport.width * scaleX;
        const height = viewport.height * scaleY;
ctx.drawImage(
            img,
            x, y, width, height,
            0, 0, targetSize, targetSize
        );
                const compressedData = canvas.toDataURL("image/jpeg", 0.6);
        if (uploadTarget === 'member') {
            mAv = compressedData;
            document.getElementById('prev-img-member').src = mAv;
        } else {
            fAv = compressedData;
        }

        // â˜… è£å®Œå¾Œï¼ŒåŒæ­¥èŠå¤©å®¤è£¡çš„å°é ­åƒ
        syncChatAvatars();

        closeCrop();
        autoSave();
    }

    function closeCrop() { document.getElementById('crop-modal').style.display = 'none'; }
    function openDrawer(id) { document.getElementById('overlay').style.display = 'block'; document.getElementById(id).classList.add('active'); }
    function closeAllDrawers() { document.getElementById('overlay').style.display = 'none'; document.querySelectorAll('.drawer').forEach(d => d.classList.remove('active')); }

function updateBubbleColors(fromLoad) {
    var c1Input = document.getElementById('bubble-color-1');
    var c2Input = document.getElementById('bubble-color-2');
    if (!c1Input || !c2Input) return;

    var c1 = c1Input.value || '#ffb7c5';
    var c2 = c2Input.value || '#ffffff';

    // å¥—åˆ°å…¨åŸŸ CSS è®Šæ•¸ï¼Œ.bubble ç”¨ var(--bubble-c1 / --bubble-c2)
    document.documentElement.style.setProperty('--bubble-c1', c1);
    document.documentElement.style.setProperty('--bubble-c2', c2);

    // ç›®å‰é€™ä¸€ç­†ç´€éŒ„ä¹Ÿä¸€èµ·æ›´æ–°
    if (currentRecordId && !fromLoad) {
        const db = getDB();
        const idx = db.findIndex(r => r.id === currentRecordId);
        if (idx !== -1) {
            db[idx].bubbleC1 = c1;
            db[idx].bubbleC2 = c2;
            saveDB(db);
        }
    }
}

    function initBubbleColors() {
        var saved = null;
        try {
            saved = JSON.parse(localStorage.getItem('bubbleColors') || '{}');
        } catch (e) { saved = null; }

        var sel1 = document.getElementById('bubble-color-1');
        var sel2 = document.getElementById('bubble-color-2');

        if (saved && saved.c1 && sel1) sel1.value = saved.c1;
        if (saved && saved.c2 && sel2) sel2.value = saved.c2;

        // ä¸€é–‹å§‹ä¹Ÿå¥—ä¸€æ¬¡ï¼ˆfromLoad = true -> ä¸å¯«å…¥ localStorageï¼‰
        updateBubbleColors(true);
    }

function takeShot() {
  const node = document.getElementById('capture-area');
  if (!node) return;

  // è®“è¼¸å‡ºåœ–æ¯”ç•«é¢é«˜è§£æåº¦ï¼ˆ2 å€ï¼‰
  const scale = 2;  // æƒ³æ›´æ¸…æ¥šå¯ä»¥æ”¹ 3

  const width  = node.offsetWidth;
  const height = node.offsetHeight;

  // ç­‰å­—å‹è¼‰å®Œï¼Œé¿å…å­—æ“ åœ¨ä¸€èµ·æˆ–è¡Œé«˜æ€ªæ€ªçš„
  const waitFonts = (document.fonts && document.fonts.ready)
    ? document.fonts.ready
    : Promise.resolve();

  waitFonts.then(function () {
    domtoimage.toPng(node, {
      width:  width * scale,
      height: height * scale,
      bgcolor: '#ffffff',

      // åªå½±éŸ¿ã€Œè¤‡è£½å‡ºä¾†çš„é‚£ä»½ã€ï¼Œç•«é¢æœ¬èº«ä¸æœƒè¢«æ”¾å¤§
      style: {
        transform: 'scale(' + scale + ')',
        transformOrigin: 'top left',
        width:  width + 'px',
        height: height + 'px'
      },

      // æŠŠæœ‰ data-html2canvas-ignore çš„æ±è¥¿éƒ½æ’é™¤ï¼ˆä¾‹å¦‚åˆªé™¤ç”¨çš„ Xï¼‰
      filter: function (el) {
        if (!el.getAttribute) return true;
        return !el.getAttribute('data-html2canvas-ignore');
      }
    }).then(function (dataUrl) {
      const link = document.createElement('a');
      link.download = 'miguri.png';
      link.href = dataUrl;
      link.click();
    }).catch(function (err) {
      console.error('æˆªåœ–å¤±æ•—ï¼š', err);
    });
  });
}

    document.addEventListener('DOMContentLoaded', function () {
    initIndexedDB();     // åŸæœ¬å°±æœ‰çš„
    renderRecordList();  // å¦‚æœä½ æœ¬ä¾†æœ‰ç”¨åˆ°
    initBubbleColors();  // æ–°åŠ çš„ï¼šæ¼¸å±¤é¡è‰²åˆå§‹åŒ–
});

</script>
<button class="fab-add"
        type="button"
        onclick="createNewRecord()"
        data-html2canvas-ignore>
  ï¼‹
</button>
<!-- æ°£æ³¡é•·æŒ‰é¸å–®ï¼šç·¨è¼¯ / åˆªé™¤ -->
<div id="chat-menu" class="chat-menu">
  <button type="button" onclick="editCurrentChat()">âœï¸ ç·¨è¼¯</button>
  <button type="button" onclick="deleteCurrentChat()">ğŸ—‘ åˆªé™¤</button>
</div>

</body>
</html>