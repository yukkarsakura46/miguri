<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sakurazaka46 ãƒŸãƒ¼ã‚°ãƒª</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --sakura-pink: #f4b4d0; --text-gray: #8e8e93; --nick-green: #2ecc71; --bg-main: #f8f9fa; }
        * { box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { background: #333; margin: 0; display: flex; justify-content: center; overflow-x: hidden; }

        /* ä¸»è¦–çª—åˆ‡æ›æ§åˆ¶ */
        .view-section { display: none; width: 450px; min-height: 100vh; background: white; position: relative; }
        .view-section.active { display: flex; flex-direction: column; }

        /* --- ä¸»ç•«é¢æ¨£å¼ --- */
        #main-dashboard { background: var(--bg-main); padding: 25px; }
        .dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .add-record-btn { background: var(--sakura-pink); color: white; border: none; padding: 12px 25px; border-radius: 25px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(244,180,208,0.4); }
        .record-list { display: flex; flex-direction: column; gap: 15px; }
        .record-card { background: white; padding: 18px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        .record-info .r-title { font-weight: bold; font-size: 1.1rem; margin-bottom: 5px; color: #333; }
        .record-info .r-meta { font-size: 0.85rem; color: #999; }
        .card-actions { display: flex; gap: 10px; }
        .btn-del { color: #ff3b30; border: none; background: none; padding: 10px; }

        /* --- ç·¨è¼¯æ¨¡å¼é è¦½é¢æ¿ --- */
        #capture-area { padding: 20px 20px 100px; flex-grow: 1; background: white; }
        .header-center { text-align: center; margin-bottom: 15px; border-bottom: 1px solid #f2f2f7; padding-bottom: 15px; position: relative; }
        
        .avatar-container { width: 85px; height: 85px; border-radius: 50%; overflow: hidden; margin: 0 auto 10px; border: 2px solid #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; }
        .header-avatar { width: 100%; height: 100%; object-fit: cover; }
        
        .header-name { font-size: 20px; font-weight: bold; margin: 0; }
        .header-date { font-size: 12px; color: var(--text-gray); margin-top: 2px; }
        .nick-label { font-size: 11px; margin-top: 5px; color: #333; }
        .header-nick { font-size: 18px; font-weight: bold; color: var(--nick-green); margin-top: 0; }
        
        .status-corner { position: absolute; right: 0; bottom: 5px; display: flex; flex-direction: column; align-items: flex-end; gap: 2px; font-size: 11px; color: var(--text-gray); }
        .status-item { display: flex; align-items: center; gap: 4px; }

        /* å°è©±æ¨£å¼ */
        .chat-list { display: flex; flex-direction: column; gap: 8px; }
        .chat-item { display: flex; align-items: flex-start; max-width: 90%; position: relative; }
        .item-member { align-self: flex-start; }
        .item-fan { align-self: flex-end; flex-direction: row-reverse; }
        .chat-avatar { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
        .item-member .chat-avatar { margin-right: 12px; }
        .item-fan .chat-avatar { margin-left: 12px; }
        .bubble { padding: 11px 16px; font-size: 15px; border-radius: 18px; line-height: 1.4; }
        .item-member .bubble { background: #fff; border: 1px solid #efeff4; border-top-left-radius: 4px; }
        .item-fan .bubble { background: #f0f0f0; border-top-right-radius: 4px; }
        .no-avatar { margin-left: 57px; }
        .item-fan.no-avatar { margin-right: 57px; margin-left: 0; }
        
        /* å…¶ä»–/OS æ¨£å¼ */
        .item-other { align-self: center; justify-content: center; width: 100%; margin: 8px 0; }
        .item-other .bubble { background: transparent; color: #ced4da; font-size: 12px; text-align: center; padding: 5px 20px; border: none; }

        /* è£å‰ªè¦–çª— */
        #crop-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; }
        .crop-viewport { width: 300px; height: 300px; border: 1px solid #fff; position: relative; overflow: hidden; }
        .crop-circle-mask { position: absolute; width: 100%; height: 100%; border-radius: 50%; box-shadow: 0 0 0 1000px rgba(0,0,0,0.5); z-index: 3; pointer-events: none; }
        .grid-line { position: absolute; background: rgba(255,255,255,0.4); z-index: 2; }
        .v1 { left: 33%; top: 0; width: 1px; height: 100%; } .v2 { left: 66%; top: 0; width: 1px; height: 100%; }
        .h1 { top: 33%; left: 0; height: 1px; width: 100%; } .h2 { top: 66%; left: 0; height: 1px; width: 100%; }
        #preview-img-raw { position: absolute; cursor: move; touch-action: none; width: auto; height: auto; }

        /* é¢æ¿æ§åˆ¶ (è¨­å®šèˆ‡å°è©±) */
        .drawer { position: fixed; bottom: -100%; left: 50%; transform: translateX(-50%); width: 100%; max-width: 450px; background: white; transition: 0.3s; z-index: 500; border-radius: 20px 20px 0 0; padding: 15px 20px; box-shadow: 0 -5px 25px rgba(0,0,0,0.2); }
        .drawer.active { bottom: 0; }
        .drawer h3 { margin: 0 0 10px 0; font-size: 16px; }

        input, select, textarea { width: 100%; padding: 8px 10px; margin-bottom: 6px; font-size: 14px; border: 1px solid #ddd; border-radius: 8px; background: #fafafa; box-sizing: border-box; max-width: 100%; }
        .config-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; width: 100%; }
        .config-grid input, .config-grid select { margin-bottom: 0; }

        .drawer-btn-group { display: flex; gap: 8px; margin-bottom: 10px; }
        .drawer-btn-group button { flex: 1; padding: 8px; font-size: 13px; border-radius: 6px; border: 1px solid #eee; background: white; cursor: pointer; }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 400; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; max-width: 450px; background: white; display: flex; justify-content: space-around; padding: 12px; border-top: 1px solid #eee; z-index: 300; }
        .nav-btn { background: none; border: none; font-size: 11px; cursor: pointer; color: #666; }
        .back-nav { background: #eee; padding: 10px; display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 13px; }
    </style>
</head>
<body>

<div id="main-dashboard" class="view-section active">
    <div class="dash-header">
        <h2 style="margin:0">ãƒŸãƒ¼ã‚°ãƒª</h2>
        <button class="add-record-btn" onclick="createNewRecord()">ï¼‹ æ–°å¢ç´€éŒ„</button>
    </div>
    <div class="record-list" id="record-list"></div>
</div>

<div id="edit-view" class="view-section">
    <div class="back-nav" onclick="backToDash()">â¬… è¿”å›ä¸»ç•«é¢</div>
    
    <div id="capture-area">
        <div class="header-center">
            <div class="avatar-container" onclick="triggerFile('member')">
                <img src="https://via.placeholder.com/150" id="prev-img-member" class="header-avatar">
            </div>
            <div id="prev-name" class="header-name">æˆå“¡</div>
            <div id="prev-date" class="header-date">æ—¥æœŸ</div>
            <div class="nick-label">ğŸ‘¤ ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ </div>
            <div id="prev-nick" class="header-nick">æš±ç¨±</div>
            
            <div class="status-corner">
                <div id="prev-part" class="status-item"></div>
                <div id="prev-cards" class="status-item"></div>
                <div id="prev-seconds" class="status-item"></div>
            </div>
        </div>
        <div class="chat-list" id="chat-list"></div>
    </div>

    <div class="bottom-nav">
        <button class="nav-btn" onclick="openDrawer('configDrawer')">âš™ï¸è¨­å®š</button>
        <button class="nav-btn" onclick="openDrawer('chatDrawer')">ğŸ’¬å°è©±</button>
        <button class="nav-btn" onclick="takeShot()" style="color:var(--sakura-pink); font-weight:bold;">ğŸ“¸æˆªåœ–</button>
    </div>
</div>

<div id="crop-modal">
    <div class="crop-viewport"><img id="preview-img-raw" src=""><div class="grid-line v1"></div><div class="grid-line v2"></div><div class="grid-line h1"></div><div class="grid-line h2"></div><div class="crop-circle-mask"></div></div>
    <div style="margin-top:30px; display:flex; gap:20px;">
        <button onclick="closeCrop()" style="color:white; background:none; border:1px solid #fff; padding:10px 20px; border-radius:20px;">å–æ¶ˆ</button>
        <button onclick="confirmCrop()" style="background:white; border:none; padding:10px 20px; border-radius:20px;">ç¢ºå®š</button>
    </div>
</div>

<div class="overlay" id="overlay" onclick="closeAllDrawers()"></div>

<div class="drawer" id="configDrawer">
    <h3>âš™ï¸ ç´€éŒ„è³‡æ–™è¨­å®š</h3>
    <div class="drawer-btn-group">
        <button onclick="triggerFile('member')">æˆå“¡ç›¸ç‰‡</button>
        <button onclick="triggerFile('fan')">æˆ‘çš„ç›¸ç‰‡</button>
    </div>
    <input type="file" id="real-file-input" style="display:none" onchange="handleFile(this)">
    <input type="text" id="input-name" placeholder="æˆå“¡å§“å" oninput="liveUpdate()">
    <input type="text" id="input-nick" placeholder="ä½ çš„æš±ç¨±" oninput="liveUpdate()">
    <input type="text" id="input-single" placeholder="å–®æ›²/å°ˆè¼¯åç¨±" oninput="autoSave()">
    <input type="date" id="input-date" oninput="liveUpdate()">
    <div class="config-grid">
        <select id="input-part" onchange="liveUpdate()">
            <option value="">éƒ¨æ•¸</option>
            <option value="ç¬¬1éƒ¨">ç¬¬1éƒ¨</option>
            <option value="ç¬¬2éƒ¨">ç¬¬2éƒ¨</option>
            <option value="ç¬¬3éƒ¨">ç¬¬3éƒ¨</option>
            <option value="ç¬¬4éƒ¨">ç¬¬4éƒ¨</option>
            <option value="ç¬¬5éƒ¨">ç¬¬5éƒ¨</option>
            <option value="ç¬¬6éƒ¨">ç¬¬6éƒ¨</option>
        </select>
        <input type="text" id="input-cards" placeholder="æšæ•¸" oninput="liveUpdate()">
        <input type="text" id="input-seconds" placeholder="ç§’æ•¸" oninput="liveUpdate()">
    </div>
</div>

<div class="drawer" id="chatDrawer">
    <h3>ğŸ’¬ æ–°å¢å…§å®¹</h3>
    <textarea id="input-msg" rows="3" style="width:100%; padding:10px; margin-bottom:10px;"></textarea>
    <div style="display:flex; gap:10px;">
        <button onclick="addChat('member')" style="flex:1; padding:10px; background:white; border:1px solid #ddd; border-radius:8px;">æˆå“¡</button>
        <button onclick="addChat('fan')" style="flex:1; padding:10px; background:#eee; border:none; border-radius:8px;">æˆ‘</button>
        <button onclick="addChat('other')" style="flex:1; padding:10px; background:#dcdde1; border:none; border-radius:8px;">å…¶ä»–</button>
    </div>
</div>

<script>
    let currentRecordId = null;
    let mAv = "", fAv = "", lastT = "";
    let uploadTarget = "";

    function getDB() { return JSON.parse(localStorage.getItem('sakura_v10_db') || "[]"); }
    function saveDB(db) { localStorage.setItem('sakura_v10_db', JSON.stringify(db)); }

    function renderRecordList() {
        const db = getDB();
        const container = document.getElementById('record-list');
        if(!container) return;
        container.innerHTML = db.length === 0 ? '<p style="text-align:center; color:#999; margin-top:20px;">ç›®å‰æ²’æœ‰è¨˜éŒ„ã€‚</p>' : '';
        [...db].reverse().forEach(r => {
            const card = document.createElement('div');
            card.className = 'record-card';
            card.onclick = () => loadEditView(r.id);
            card.innerHTML = `
                <div class="record-info">
                    <div class="r-title">${r.name || 'æˆå“¡'} ${r.single ? `<span style="font-size:0.8rem; color:var(--sakura-pink); font-weight:normal;">[${r.single}]</span>` : ''}</div>
                    <div class="r-meta">${r.date || 'ç„¡æ—¥æœŸ'} | ${r.part || ''}</div>
                </div>
                <div class="card-actions"><button class="btn-del" onclick="event.stopPropagation(); deleteRecord(${r.id})">ğŸ—‘ï¸</button></div>
            `;
            container.appendChild(card);
        });
    }

    function createNewRecord() {
        const id = Date.now();
        const db = getDB();
        db.push({ id, name: "", single: "", date: "", part: "", chats: "", mAv: "", fAv: "", nick: "", cards: "", seconds: "" });
        saveDB(db);
        loadEditView(id);
    }

    function deleteRecord(id) {
        if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ")) return;
        saveDB(getDB().filter(r => r.id !== id));
        renderRecordList();
    }

    function loadEditView(id) {
        currentRecordId = id;
        const db = getDB();
        const r = db.find(item => item.id === id);
        
        // å®‰å…¨å¡«å……è¼¸å…¥æ¡†ï¼Œé˜²æ­¢ä¸å­˜åœ¨æ™‚å ±éŒ¯
        const setVal = (id, val) => { if(document.getElementById(id)) document.getElementById(id).value = val || ""; };
        setVal('input-single', r.single);
        setVal('input-name', r.name);
        setVal('input-nick', r.nick);
        setVal('input-date', r.date);
        setVal('input-part', r.part);
        setVal('input-cards', r.cards);
        setVal('input-seconds', r.seconds);
        
        document.getElementById('chat-list').innerHTML = r.chats || "";
        mAv = r.mAv; fAv = r.fAv;
        document.getElementById('prev-img-member').src = mAv || "https://via.placeholder.com/150";
        
        liveUpdate();
        document.getElementById('main-dashboard').classList.remove('active');
        document.getElementById('edit-view').classList.add('active');
    }

    function backToDash() {
    try {
        autoSave(); // å˜—è©¦å­˜æª”
    } catch (e) {
        console.warn("å­˜æª”å¤±æ•—ï¼ˆå¯èƒ½æ˜¯åœ–ç‰‡å¤ªå¤§ï¼‰ï¼š", e);
        // å¦‚æœæ˜¯å› ç‚ºç©ºé–“ä¸è¶³ï¼Œå¯ä»¥æç¤ºä½¿ç”¨è€…åˆªé™¤èˆŠç´€éŒ„
    }

    // å¼·åˆ¶åˆ‡æ›è¦–çª—
    const editView = document.getElementById('edit-view');
    const dashView = document.getElementById('main-dashboard');
    
    if (editView && dashView) {
        editView.classList.remove('active');
        dashView.classList.add('active');
        renderRecordList(); 
    }
}

    function autoSave() {
    if(!currentRecordId) return;
    const db = getDB();
    const idx = db.findIndex(r => r.id === currentRecordId);
    if(idx === -1) return;
    
    const getVal = (id) => document.getElementById(id) ? document.getElementById(id).value : "";

    db[idx] = {
        ...db[idx],
        name: getVal('input-name'),
        single: getVal('input-single'), // å„²å­˜å–®æ›²åç¨±
        nick: getVal('input-nick'),
        date: getVal('input-date'),
        part: getVal('input-part'),
        cards: getVal('input-cards'),
        seconds: getVal('input-seconds'),
        chats: document.getElementById('chat-list').innerHTML,
        mAv: mAv, // ç¢ºä¿æˆå“¡é ­åƒæ•¸æ“šè¢«å­˜å…¥
        fAv: fAv  // ç¢ºä¿ç²‰çµ²é ­åƒæ•¸æ“šè¢«å­˜å…¥
    };
    saveDB(db);
}

    function liveUpdate() {
        const getVal = (id) => document.getElementById(id) ? document.getElementById(id).value : "";
        
        document.getElementById('prev-name').innerText = getVal('input-name') || "æˆå“¡";
        document.getElementById('prev-nick').innerText = getVal('input-nick') || "æš±ç¨±";
        
        const dateVal = getVal('input-date');
        if (dateVal) {
            const dateObj = new Date(dateVal);
            const weekDay = ["æ—¥", "ä¸€", "äºŒ", "ä¸‰", "å››", "äº”", "å…­"][dateObj.getDay()];
            document.getElementById('prev-date').innerText = `${dateObj.getMonth() + 1}/${dateObj.getDate()}(${weekDay})`;
        } else {
            document.getElementById('prev-date').innerText = "æ—¥æœŸ";
        }

        // å³å´é è¦½ (åœ–æ¡ˆ + å–®ä½)
        document.getElementById('prev-part').innerText = getVal('input-part');
        const cards = getVal('input-cards');
        document.getElementById('prev-cards').innerText = cards ? `ğŸ« ${cards} æš` : "";
        const seconds = getVal('input-seconds');
        document.getElementById('prev-seconds').innerText = seconds ? `â±ï¸ ${seconds} ç§’` : "";
        
        autoSave();
    }

    function addChat(type) {
        const msg = document.getElementById('input-msg').value; 
        if(!msg) return;
        const list = document.getElementById('chat-list');
        const div = document.createElement('div');
        if(type === 'other') {
            div.className = 'chat-item item-other';
            div.innerHTML = `<span style="position:absolute; right:10px; opacity:0.2; cursor:pointer;" onclick="this.parentElement.remove()">âœ•</span><div class="bubble">${msg.replace(/\n/g,'<br>')}</div>`;
        } else {
            const isC = (type === lastT);
            div.className = `chat-item item-${type} ${isC ? 'no-avatar' : ''}`;
            div.innerHTML = `<span style="position:absolute; top:0; ${type==='member'?'right': 'left'}:-25px; opacity:0.2; cursor:pointer;" onclick="this.parentElement.remove()">âœ•</span>${!isC ? `<img src="${type==='member' ? mAv : fAv}" class="chat-avatar">` : ''}<div class="bubble">${msg.replace(/\n/g,'<br>')}</div>`;
        }
        list.appendChild(div); lastT = type; document.getElementById('input-msg').value = '';
        autoSave();
    }

    function triggerFile(t) { uploadTarget = t; document.getElementById('real-file-input').click(); }
    
    function handleFile(i) {
        const file = i.files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = e => { 
                const img = document.getElementById('preview-img-raw');
                img.src = e.target.result; 
                document.getElementById('crop-modal').style.display = 'flex'; 
                
                img.onload = function() {
                    // è‡ªå‹•å°‡åœ–ç‰‡ç¸®å°åˆ°é©åˆè£åˆ‡æ¡†çš„å¤§å° (300px)
                    const scale = 300 / Math.min(img.naturalWidth, img.naturalHeight);
                    img.style.width = (img.naturalWidth * scale) + "px";
                    img.style.height = (img.naturalHeight * scale) + "px";
                    img.style.top = '0px';
                    img.style.left = '0px';
                };
            };
            reader.readAsDataURL(file);
        }
    }

    let isD = false; const rawI = document.getElementById('preview-img-raw');
    rawI.onmousedown = () => isD = true; window.onmouseup = () => isD = false;
    window.onmousemove = e => { if(isD) { rawI.style.left = (rawI.offsetLeft + e.movementX) + 'px'; rawI.style.top = (rawI.offsetTop + e.movementY) + 'px'; } };
    
    // æ”¯æ´è§¸æ§æ‹–æ›³
    rawI.ontouchstart = () => isD = true; rawI.ontouchend = () => isD = false;
    rawI.ontouchmove = e => { 
        if(isD) {
            const touch = e.touches[0];
            rawI.style.left = (rawI.offsetLeft + (touch.clientX - (rawI.lastX || touch.clientX))) + 'px';
            rawI.style.top = (rawI.offsetTop + (touch.clientY - (rawI.lastY || touch.clientY))) + 'px';
            rawI.lastX = touch.clientX; rawI.lastY = touch.clientY;
        }
    };

    function confirmCrop() {
    const imgData = rawI.src; 
    if(uploadTarget === 'member') { 
        mAv = imgData; 
        document.getElementById('prev-img-member').src = mAv; 
    } else { 
        fAv = imgData; 
    }
    closeCrop();
    
    // å»¶é²å­˜æª”ï¼Œé¿å…é˜»å¡ UI å‹•ç•«
    setTimeout(() => {
        autoSave();
    }, 100);
}
    function closeCrop() { document.getElementById('crop-modal').style.display='none'; }

    function openDrawer(id) { document.getElementById('overlay').style.display='block'; document.getElementById(id).classList.add('active'); }
    function closeAllDrawers() { document.getElementById('overlay').style.display='none'; document.querySelectorAll('.drawer').forEach(d=>d.classList.remove('active')); }
    
    function takeShot() {
        closeAllDrawers();
        const area = document.querySelector("#capture-area");
        html2canvas(area, { 
            scale: 4, 
            useCORS: true,
            backgroundColor: "#ffffff"
        }).then(c => {
            const a = document.createElement('a'); 
            a.download='Meguri_Log_' + Date.now() + '.png'; 
            a.href=c.toDataURL("image/png", 1.0); 
            a.click();
        });
    }

    document.addEventListener('DOMContentLoaded', renderRecordList);
</script>

</body>
</html>